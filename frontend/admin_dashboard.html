<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö ‚Äî Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; }
    .admin-gradient { background: linear-gradient(135deg,#0f172a 0%, #1e1b4b 100%); }
    .glass-card { background: white; border: 1px solid #f1f5f9; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.025); border-radius: 1.5rem; transition: transform 0.2s; }
    .glass-card:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  </style>
</head>
<body class="min-h-screen text-slate-800">

  <header class="admin-gradient text-white shadow-lg sticky top-0 z-50">
    <nav class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between relative">
      <a href="./admin_dashboard.html" class="flex items-center gap-3 group relative z-10">
        <img src="http://127.0.0.1:8000/static/logo.png" alt="Logo" class="h-12 w-auto object-contain bg-white/10 rounded p-1 backdrop-blur-sm border border-white/10">
        <div class="leading-tight">
          <div class="font-bold text-lg tracking-wide">ADMIN CONSOLE</div>
          <div class="text-[10px] text-slate-400 tracking-wider group-hover:text-white transition">DASHBOARD</div>
        </div>
      </a>
      
      <div class="relative bg-white/10 p-1.5 rounded-xl hidden md:flex items-center gap-1 backdrop-blur-md border border-white/5">
        <div id="nav-slider" class="absolute h-[calc(100%-12px)] top-1.5 bg-white/20 rounded-lg transition-all duration-300 ease-out opacity-0 pointer-events-none z-0"></div>
        <a href="./admin_dashboard.html" class="nav-link px-4 py-2 rounded-lg text-sm font-bold bg-white text-slate-900 shadow-lg shadow-black/20 relative z-10 transition-colors" data-page="dashboard">üìä Dashboard</a>
        <a href="./admin_users.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="users">üë• Users</a>
        <a href="./admin_courses.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="courses">üìö Courses</a>
        <a href="./admin_payments.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="payments">üí∞ Payments</a>
        <a href="./admin_exams.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="exams">üìù Exams</a>
        <a href="./admin_settings.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="settings">‚öôÔ∏è Settings</a>
      </div>

      <div class="flex items-center gap-4 relative z-10">
        <button onclick="logout()" class="text-xs bg-red-500/20 hover:bg-red-500 text-red-100 hover:text-white border border-red-500/30 px-3 py-1.5 rounded transition">Logout</button>
      </div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-10 space-y-10">
    
    <div class="flex flex-col md:flex-row justify-between items-end gap-4">
      <div>
        <h1 class="text-3xl font-bold text-slate-900 flex items-center gap-2">üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô!</h1>
        <p class="text-slate-500 text-sm mt-1">‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö MingSmileyFace</p>
      </div>
      <div class="flex gap-3">
        <a href="./admin_courses.html" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 text-sm font-bold rounded-xl hover:bg-slate-50 hover:border-indigo-200 hover:text-indigo-600 transition flex items-center gap-2 shadow-sm">
          <span>üìö</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏™
        </a>
        <a href="./admin_payments.html" class="px-4 py-2 bg-indigo-600 text-white text-sm font-bold rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 flex items-center gap-2">
          <span>üí∞</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ <span id="badgePending" class="hidden bg-white text-indigo-600 text-[10px] px-1.5 rounded-full">0</span>
        </a>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      
      <div class="glass-card p-6 relative overflow-hidden group cursor-pointer" onclick="location.href='./admin_payments.html'">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110">
          <svg class="w-24 h-24 text-indigo-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39h-2.05c-.11-.7-.59-1.74-1.99-1.74-1.4 0-2.1.6-2.1 1.33 0 .69.35 1.3 2.67 1.81 2.55.61 4.2 1.57 4.2 3.82 0 1.92-1.38 3.13-3.17 3.54z"/></svg>
        </div>
        <div class="relative z-10">
          <p class="text-xs font-bold text-indigo-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</p>
          <h3 class="text-3xl font-black text-slate-800 mt-2">‡∏ø <span id="valRevenue">-</span></h3>
          <p class="text-[10px] text-slate-400 mt-1">‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        </div>
      </div>

      <div class="glass-card p-6 relative overflow-hidden group cursor-pointer" onclick="location.href='./admin_users.html'">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110">
          <svg class="w-24 h-24 text-emerald-600" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        </div>
        <div class="relative z-10">
          <p class="text-xs font-bold text-emerald-500 uppercase tracking-wider">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
          <h3 class="text-3xl font-black text-slate-800 mt-2"><span id="valUsers">-</span></h3>
          <div class="flex items-center gap-2 mt-1">
            <span class="bg-emerald-100 text-emerald-700 text-[10px] px-1.5 py-0.5 rounded font-bold">+<span id="valNewUsers">0</span> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
          </div>
        </div>
      </div>

      <div class="glass-card p-6 relative overflow-hidden group">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110">
          <svg class="w-24 h-24 text-blue-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        </div>
        <div class="relative z-10">
          <p class="text-xs font-bold text-blue-500 uppercase tracking-wider">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
          <h3 class="text-3xl font-black text-slate-800 mt-2"><span id="valActive">-</span></h3>
          <div class="flex items-center gap-1 mt-1">
            <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span></span>
            <span class="text-[10px] text-slate-400">Active Users (5 min)</span>
          </div>
        </div>
      </div>

      <div class="glass-card p-6 relative overflow-hidden group cursor-pointer border-orange-100 bg-orange-50/30 hover:bg-orange-50/50" onclick="location.href='./admin_payments.html'">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110">
          <svg class="w-24 h-24 text-orange-500" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
        </div>
        <div class="relative z-10">
          <p class="text-xs font-bold text-orange-500 uppercase tracking-wider">‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
          <h3 class="text-3xl font-black text-orange-500 mt-2" id="valPending">-</h3>
          <p class="text-[10px] text-orange-400 mt-1 font-bold">‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
        </div>
      </div>

    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <div class="lg:col-span-2 space-y-8">
        <div class="glass-card p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-800 flex items-center gap-2"><span class="w-2 h-6 bg-indigo-600 rounded-full"></span> ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô</h3>
            <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">Updated: Just now</span>
          </div>
          <div class="h-64 w-full"><canvas id="chartRevenue"></canvas></div>
        </div>

        <div class="glass-card p-6">
          <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-4"><span class="w-2 h-6 bg-slate-600 rounded-full"></span> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
          <div class="overflow-hidden">
            <table class="w-full text-left text-sm">
              <tbody id="listAudit" class="divide-y divide-slate-50">
                <tr><td class="p-4 text-center text-slate-400">Loading...</td></tr>
              </tbody>
            </table>
            <a href="./admin_audit.html" class="block text-center text-xs font-bold text-indigo-600 hover:bg-indigo-50 py-3 mt-2 rounded-lg transition">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</a>
          </div>
        </div>
      </div>

      <div class="space-y-8">
        
        <div class="glass-card p-6 flex flex-col">
          <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><span class="w-2 h-6 bg-pink-500 rounded-full"></span> ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h3>
          <div class="flex-1 flex justify-center items-center relative min-h-[250px]">
            <canvas id="chartCourses"></canvas>
          </div>
        </div>

        <div class="glass-card p-6">
          <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><span class="w-2 h-6 bg-emerald-500 rounded-full"></span> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
          <div class="space-y-3" id="listNewUsers">
            </div>
        </div>

      </div>
    </div>

  </main>

  <script>
    const API = (window.location.hostname==="127.0.0.1"||window.location.hostname==="localhost")?"http://127.0.0.1:8000":"https://edtech-api-zigm.onrender.com";
    const token = localStorage.getItem("token");
    if (!token) location.href = "./login.html";
    function logout(){ localStorage.removeItem("token"); location.href="./login.html"; }

    const df = new Intl.DateTimeFormat('th-TH', { dateStyle:'short', timeStyle:'short' });
    const timeAgo = (date) => {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
        return "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
    };

    // Navbar Animation
    const page="dashboard"; const slider=document.getElementById("nav-slider"); const links=document.querySelectorAll(".nav-link"); let activeLink=null;
    links.forEach(link=>{ if(link.dataset.page===page){activeLink=link;link.classList.add("text-white");moveSlider(link);slider.style.opacity="1";} link.addEventListener("mouseenter",(e)=>{moveSlider(e.target);slider.style.opacity="1";});});
    document.querySelector(".relative.bg-white\\/10").addEventListener("mouseleave",()=>{if(activeLink)moveSlider(activeLink);else slider.style.opacity="0";});
    function moveSlider(el){slider.style.width=el.offsetWidth+"px";slider.style.left=el.offsetLeft+"px";}

    async function initDashboard() {
      try {
        // 1. Fetch All Data
        const [resM, resP, resU, resA] = await Promise.all([
            fetch(`${API}/admin/metrics`, { headers: { Authorization: `Bearer ${token}` }}),
            fetch(`${API}/admin/payment-stats`, { headers: { Authorization: `Bearer ${token}` }}),
            fetch(`${API}/admin/users?page=1&page_size=5&sort=created_at:desc`, { headers: { Authorization: `Bearer ${token}` }}),
            fetch(`${API}/admin/audit?page=1&page_size=5`, { headers: { Authorization: `Bearer ${token}` }})
        ]);

        const metrics = await resM.json();
        const payStats = await resP.json();
        const recentUsers = await resU.json();
        const auditLogs = await resA.json();

        // 2. Fill Stats
        document.getElementById("valRevenue").textContent = payStats.total_revenue.toLocaleString();
        document.getElementById("valUsers").textContent = metrics.total_users.toLocaleString();
        document.getElementById("valNewUsers").textContent = metrics.new_users_today;
        document.getElementById("valActive").textContent = metrics.active_users;
        
        const pPending = payStats.pending_count;
        document.getElementById("valPending").textContent = pPending;
        if(pPending > 0) {
            const b = document.getElementById("badgePending");
            b.classList.remove("hidden");
            b.textContent = pPending;
        }

        // 3. Render Charts
        renderRevenueChart(payStats.chart_labels, payStats.chart_data);
        renderCourseChart(payStats.top_courses);

        // 4. Render New Users
        document.getElementById("listNewUsers").innerHTML = recentUsers.items.map(u => `
          <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-slate-50 transition">
            <img src="${u.avatar_url ? (u.avatar_url.startsWith("http")?u.avatar_url:`${API}${u.avatar_url}`) : `https://ui-avatars.com/api/?name=${u.email}`}" class="w-10 h-10 rounded-full bg-slate-200 object-cover border border-slate-200">
            <div class="flex-1 min-w-0">
              <div class="font-bold text-sm text-slate-700 truncate">${u.full_name||"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"}</div>
              <div class="text-xs text-slate-400 truncate">${u.email}</div>
            </div>
            <div class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">${timeAgo(u.created_at)}</div>
          </div>
        `).join("");

        // 5. Render Audit Logs
        document.getElementById("listAudit").innerHTML = auditLogs.items.map(l => `
            <tr class="hover:bg-slate-50/50 transition">
                <td class="p-3 w-12 text-center"><span class="text-lg">${getActionIcon(l.action)}</span></td>
                <td class="p-3">
                    <div class="font-bold text-xs text-slate-700">${l.action}</div>
                    <div class="text-[10px] text-slate-400">User ID: ${l.actor_id || "System"}</div>
                </td>
                <td class="p-3 text-right text-[10px] text-slate-400 whitespace-nowrap">${timeAgo(l.created_at)}</td>
            </tr>
        `).join("");

      } catch(e) { console.error(e); }
    }

    function getActionIcon(action) {
        if(action.includes("LOGIN")) return "üîë";
        if(action.includes("SIGNUP")) return "üëã";
        if(action.includes("UPDATE")) return "‚úèÔ∏è";
        if(action.includes("DELETE")) return "üóëÔ∏è";
        return "üìù";
    }

    function renderRevenueChart(labels, data) {
      new Chart(document.getElementById('chartRevenue'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
            data: data,
            borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3, pointRadius: 4, pointBackgroundColor: '#ffffff', pointBorderColor: '#6366f1',
            fill: true, tension: 0.4
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
          scales: { y: { beginAtZero: true, grid: { borderDash: [4, 4], color: '#f1f5f9' } }, x: { grid: { display: false } } },
          interaction: { mode: 'nearest', axis: 'x', intersect: false }
        }
      });
    }

    function renderCourseChart(courses) {
      if(!courses || courses.length === 0) return;
      new Chart(document.getElementById('chartCourses'), {
        type: 'doughnut',
        data: {
          labels: courses.map(c => c.title),
          datasets: [{
            data: courses.map(c => c.amount),
            backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6'],
            borderWidth: 0, hoverOffset: 15
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false, cutout: '70%',
          plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { size: 10 } } } }
        }
      });
    }

    initDashboard();
  </script>
</body>
</html>