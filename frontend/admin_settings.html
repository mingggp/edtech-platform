<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ‚Äî Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; }
    .admin-gradient { background: linear-gradient(135deg,#111827 0%, #1e1b4b 100%); }
    .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
    .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
    .setting-card { transition: all 0.2s; border: 1px solid #e2e8f0; }
    .setting-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border-color: #cbd5e1; }
  </style>
</head>
<body class="min-h-screen text-slate-800">

  <header class="admin-gradient text-white shadow-md sticky top-0 z-50">
    <nav class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between relative">
      <a href="./admin_users.html" class="flex items-center gap-3 group relative z-10"><img src="http://127.0.0.1:8000/static/logo.png" alt="Logo" class="h-12 w-auto object-contain bg-white/10 rounded p-1"><div class="leading-tight"><div class="font-bold text-lg">ADMIN CONSOLE</div></div></a>
      <div class="relative bg-white/10 p-1.5 rounded-xl hidden md:flex items-center gap-1">
        <div id="nav-slider" class="absolute h-[calc(100%-12px)] top-1.5 bg-white/20 rounded-lg transition-all duration-300 ease-out opacity-0 pointer-events-none z-0"></div>
        <a href="./admin_users.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="users">üë• Users</a>
        <a href="./admin_courses.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="courses">üìö Courses</a>
        <a href="./admin_payments.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="payments">üí∞ Payments</a>
        <a href="./admin_exams.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="exams">üìù Exams</a>
        <a href="./admin_audit.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="audit">üõ°Ô∏è Logs</a>
        <a href="./admin_settings.html" class="nav-link px-4 py-2 rounded-lg text-sm font-bold text-slate-300 hover:text-white relative z-10 transition-colors" data-page="settings">‚öôÔ∏è Settings</a>
      </div>
      <div class="flex items-center gap-4 relative z-10"><a href="./me.html" class="text-xs text-slate-300 hover:text-white transition">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a><button onclick="logout()" class="text-xs bg-red-500/20 hover:bg-red-500 text-red-100 px-3 py-1.5 rounded transition">Logout</button></div>
    </nav>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-10 space-y-10">
    <div class="flex items-center gap-4 mb-2"><div class="p-3 bg-white rounded-xl shadow-sm border border-slate-200"><span class="text-2xl">‚öôÔ∏è</span></div><div><h1 class="text-3xl font-bold text-slate-900">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h1><p class="text-slate-500 text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå, ‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö, ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡πà‡∏≤‡∏á‡πÜ</p></div></div>

    <div class="setting-card bg-white rounded-3xl p-6 md:p-8">
      <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg text-sm">üñºÔ∏è</span> ‡∏™‡πÑ‡∏•‡∏î‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image Slider)</h2>
        <div class="flex items-center gap-3">
            <span class="text-sm font-bold text-slate-500">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</span>
            <div class="relative inline-block w-12 mr-2 align-middle select-none"><input type="checkbox" id="imgBannerActive" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 checked:right-0 transition-all duration-300"/><label for="imgBannerActive" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div>
        </div>
      </div>
      
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6" id="bannerImageList"></div>

      <div class="flex flex-col md:flex-row gap-4 items-center bg-slate-50 p-4 rounded-2xl border border-slate-200 border-dashed hover:border-indigo-300 transition group">
        <div class="flex-1 w-full">
          <label class="block text-sm font-bold text-slate-700 mb-1">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ)</label>
          <input type="file" id="bannerFile" accept="image/*" multiple class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer bg-white border rounded-lg">
        </div>
        <div class="w-32">
           <label class="block text-xs font-bold text-slate-500 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
           <input type="number" id="bannerInterval" class="w-full border rounded-lg px-3 py-2 text-sm text-center font-bold" value="10" min="1">
        </div>
        <button onclick="uploadBanner()" id="btnUpload" class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl text-sm font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition disabled:opacity-50">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      <div class="setting-card bg-white p-6 md:p-8 rounded-3xl flex flex-col h-full">
        <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><span class="bg-pink-100 text-pink-600 p-1.5 rounded-lg text-sm">üì¢</span> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h2><div class="relative inline-block w-12 mr-2 align-middle select-none"><input type="checkbox" id="bannerActive" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 checked:right-0 transition-all duration-300"/><label for="bannerActive" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div></div>
        <form id="bannerForm" class="flex-1 flex flex-col gap-4">
          <div class="flex-1"><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label><textarea id="bannerText" rows="3" class="w-full border border-slate-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-pink-500 outline-none transition" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á..."></textarea></div>
          <button type="submit" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition shadow-lg mt-auto">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </form>
      </div>

      <div class="setting-card bg-white p-6 md:p-8 rounded-3xl flex flex-col h-full">
        <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><span class="bg-orange-100 text-orange-600 p-1.5 rounded-lg text-sm">‚è≥</span> ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á</h2><div class="relative inline-block w-12 mr-2 align-middle select-none"><input type="checkbox" id="cdActive" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 checked:right-0 transition-all duration-300"/><label for="cdActive" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div></div>
        <form id="countdownForm" class="flex-1 flex flex-col gap-4">
          <div><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label><input id="cdTitle" class="w-full border border-slate-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-orange-500 outline-none transition" placeholder="‡πÄ‡∏ä‡πà‡∏ô TGAT Exam"></div>
          <div class="flex-1"><label class="block text-xs font-bold text-slate-500 mb-1 ml-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label><input id="cdDate" type="date" class="w-full border border-slate-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-orange-500 outline-none transition cursor-pointer"></div>
          <button type="submit" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition shadow-lg mt-auto">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        </form>
      </div>
    </div>
  </main>

  <script>
    // Navbar Animation
    const page="settings"; const slider=document.getElementById("nav-slider"); const links=document.querySelectorAll(".nav-link"); let activeLink=null;
    links.forEach(link=>{ if(link.dataset.page===page){activeLink=link;link.classList.add("text-white");moveSlider(link);slider.style.opacity="1";} link.addEventListener("mouseenter",(e)=>{moveSlider(e.target);slider.style.opacity="1";});});
    document.querySelector(".relative.bg-white\\/10").addEventListener("mouseleave",()=>{if(activeLink)moveSlider(activeLink);else slider.style.opacity="0";});
    function moveSlider(el){slider.style.width=el.offsetWidth+"px";slider.style.left=el.offsetLeft+"px";}

    const API = (window.location.hostname==="127.0.0.1"||window.location.hostname==="localhost")?"http://127.0.0.1:8000":"https://edtech-api-zigm.onrender.com";
    const token = localStorage.getItem("token");
    if (!token) location.href = "./login.html";
    function logout(){ localStorage.removeItem("token"); location.href="./login.html"; }

    async function loadSettings() {
      try {
        const res = await fetch(`${API}/settings`, { headers: { Authorization: `Bearer ${token}` } });
        const s = await res.json();
        
        if(s.banner_text) document.getElementById("bannerText").value = s.banner_text;
        document.getElementById("bannerActive").checked = (s.banner_active === "true");
        
        if(s.countdown_title) document.getElementById("cdTitle").value = s.countdown_title;
        if(s.countdown_date) document.getElementById("cdDate").value = s.countdown_date;
        document.getElementById("cdActive").checked = (s.countdown_active === "true");

        document.getElementById("imgBannerActive").checked = (s.image_banner_active === "true");
        if(s.banner_interval) document.getElementById("bannerInterval").value = s.banner_interval;

        renderImages(s.banner_images || []);
      } catch(e) { console.error(e); }
    }

    function renderImages(images) {
      const el = document.getElementById("bannerImageList");
      if(images.length === 0) { el.innerHTML = `<div class="col-span-full py-8 text-center text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-300 text-xs">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</div>`; return; }
      el.innerHTML = images.map(url => {
        const fullUrl = url.startsWith("http") ? url : `${API}${url}`;
        return `<div class="relative group rounded-xl overflow-hidden border border-slate-200 aspect-video bg-slate-100 shadow-sm hover:shadow-md transition"><img src="${fullUrl}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2"><button onclick="deleteImage('${url}')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transform scale-90 hover:scale-110 transition"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></div>`;
      }).join("");
    }

    async function uploadBanner() {
      const fileInput = document.getElementById("bannerFile");
      const files = fileInput.files;
      const interval = document.getElementById("bannerInterval").value;
      
      if(files.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
      const btn = document.getElementById("btnUpload");
      btn.disabled = true; btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";

      try {
        // Save interval first
        await fetch(`${API}/admin/settings`, { method: "PATCH", headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` }, body: JSON.stringify({ banner_interval: interval }) });
        
        // Loop upload files
        for (const file of files) {
           const fd = new FormData(); fd.append("file", file);
           await fetch(`${API}/admin/settings/banner-image`, { method: "POST", headers: { Authorization: `Bearer ${token}` }, body: fd });
        }
        
        const res = await fetch(`${API}/settings`);
        const s = await res.json();
        renderImages(s.banner_images || []);
        fileInput.value = "";
        alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");

      } catch(e) { alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
      btn.disabled = false; btn.textContent = "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
    }

    async function deleteImage(url) {
      if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ?")) return;
      try {
        const res = await fetch(`${API}/admin/settings/banner-image`, { method: "DELETE", headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` }, body: JSON.stringify({ url }) });
        if(!res.ok) throw new Error();
        const data = await res.json(); renderImages(data.images);
      } catch { alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
    }

    async function save(payload) {
      try {
        await fetch(`${API}/admin/settings`, { method: "PATCH", headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` }, body: JSON.stringify(payload) });
        // Feedback animation on button could be added here
      } catch { alert("Error saving settings"); }
    }

    document.getElementById("imgBannerActive").addEventListener("change", (e) => save({ image_banner_active: e.target.checked }));
    document.getElementById("bannerActive").addEventListener("change", (e) => save({ banner_active: e.target.checked }));
    document.getElementById("cdActive").addEventListener("change", (e) => save({ countdown_active: e.target.checked }));

    document.getElementById("bannerForm").addEventListener("submit", (e) => { e.preventDefault(); save({ banner_text: document.getElementById("bannerText").value, banner_active: document.getElementById("bannerActive").checked }); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß"); });
    document.getElementById("countdownForm").addEventListener("submit", (e) => { e.preventDefault(); save({ countdown_title: document.getElementById("cdTitle").value, countdown_date: document.getElementById("cdDate").value, countdown_active: document.getElementById("cdActive").checked }); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Countdown ‡πÅ‡∏•‡πâ‡∏ß"); });

    loadSettings();
  </script>
</body>
</html>