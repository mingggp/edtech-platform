<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>System Settings — Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style> 
    body { font-family: 'Prompt', sans-serif; background-color: #f1f5f9; }
    
    /* Toggle Switch */
    .toggle-checkbox:checked { right: 0; border-color: #10b981; }
    .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
    .toggle-checkbox { right: auto; left: 0; transition: all 0.3s ease-in-out; }
    .toggle-label { width: 3rem; height: 1.5rem; transition: background-color 0.3s ease-in-out; }
    
    /* Custom Checkbox */
    .custom-checkbox:checked { background-color: #4f46e5; border-color: #4f46e5; }
    .custom-checkbox:checked:after { content: '✔'; display: block; text-align: center; color: white; font-size: 10px; line-height: 14px; }
  </style>
</head>
<body class="text-slate-800">

  <div class="flex min-h-screen">
    <aside class="w-64 bg-slate-900 text-white flex flex-col fixed h-full z-20 shadow-xl">
      <div class="h-20 flex items-center justify-center border-b border-slate-800">
        <h1 class="text-2xl font-bold tracking-tighter flex items-center gap-2"><span class="text-indigo-500">❖</span> Admin</h1>
      </div>
      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <a href="./admin_dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition group"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard</a>
        <a href="./admin_users.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition group"><i data-lucide="users" class="w-5 h-5"></i> Users</a>
        <a href="./admin_courses.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition group"><i data-lucide="book-open" class="w-5 h-5"></i> Courses</a>
        <a href="./admin_settings.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-indigo-600/20 text-indigo-400 font-bold border border-indigo-600/30 shadow-sm"><i data-lucide="settings" class="w-5 h-5"></i> System Settings</a>
      </nav>
    </aside>

    <main class="flex-1 ml-64 p-8">
      <header class="flex justify-between items-end mb-8">
        <div>
          <h2 class="text-3xl font-bold text-slate-800 mb-1">System Settings ⚙️</h2>
          <p class="text-slate-500">จัดการการแสดงผลบนหน้า Dashboard ของนักเรียน</p>
        </div>
        <button onclick="saveSettings()" class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center gap-2 transform hover:-translate-y-0.5">
          <i data-lucide="save" class="w-4 h-4"></i> บันทึกการตั้งค่า
        </button>
      </header>

      <div class="space-y-6 max-w-5xl mx-auto pb-20">
        
        <section class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden group hover:shadow-md transition duration-300">
            <div class="flex justify-between items-center mb-6 relative z-10">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center"><i data-lucide="megaphone" class="w-6 h-6"></i></div>
                    <div><h3 class="font-bold text-xl text-slate-800">Announcement Banner</h3><p class="text-sm text-slate-500">แถบประกาศข้อความด้านบนสุด</p></div>
                </div>
                <div class="relative inline-block w-14 align-middle select-none">
                    <input type="checkbox" id="bannerActive" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 border-slate-200 appearance-none cursor-pointer translate-y-[-2px] shadow-sm"/>
                    <label for="bannerActive" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer"></label>
                </div>
            </div>
            <div class="relative z-10 bg-slate-50 p-6 rounded-2xl border border-slate-100">
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1">ข้อความประกาศ</label>
                <div class="relative">
                    <input type="text" id="bannerText" class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none transition font-medium text-slate-700" placeholder="เช่น ยินดีต้อนรับสู่เทอมใหม่!">
                    <i data-lucide="type" class="w-4 h-4 absolute left-3.5 top-3.5 text-slate-400"></i>
                </div>
            </div>
        </section>

        <section class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden group hover:shadow-md transition duration-300">
            <div class="flex justify-between items-center mb-6 relative z-10">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-pink-50 text-pink-600 flex items-center justify-center"><i data-lucide="images" class="w-6 h-6"></i></div>
                    <div><h3 class="font-bold text-xl text-slate-800">Hero Image Slider</h3><p class="text-sm text-slate-500">สไลด์รูปภาพขนาดใหญ่หน้าแรก</p></div>
                </div>
                <div class="relative inline-block w-14 align-middle select-none">
                    <input type="checkbox" id="imgBannerActive" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 border-slate-200 appearance-none cursor-pointer translate-y-[-2px] shadow-sm"/>
                    <label for="imgBannerActive" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer"></label>
                </div>
            </div>
            <div class="relative z-10 space-y-6">
                <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">อัปโหลดรูปใหม่</label>
                        <div class="flex gap-2">
                            <input type="file" id="bannerFile" class="hidden" onchange="uploadBanner()">
                            <button onclick="document.getElementById('bannerFile').click()" class="flex-1 border-2 border-dashed border-slate-300 rounded-xl py-2.5 text-sm font-bold text-slate-500 hover:border-pink-400 hover:text-pink-500 hover:bg-pink-50 transition flex items-center justify-center gap-2">
                                <i data-lucide="upload-cloud" class="w-4 h-4"></i> เลือกไฟล์รูปภาพ
                            </button>
                        </div>
                    </div>
                    <div class="w-px h-12 bg-slate-200"></div>
                    <div class="w-32">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 text-center">ความเร็ว (วินาที)</label>
                        <input type="number" id="bannerInterval" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-center font-bold text-slate-700 outline-none" value="5">
                    </div>
                </div>
                <div id="bannerList" class="grid grid-cols-4 gap-4"></div>
            </div>
        </section>

        <section class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden group hover:shadow-md transition duration-300">
            <div class="flex justify-between items-center mb-6 relative z-10">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-orange-50 text-orange-600 flex items-center justify-center"><i data-lucide="timer" class="w-6 h-6"></i></div>
                    <div><h3 class="font-bold text-xl text-slate-800">Exam Countdown</h3><p class="text-sm text-slate-500">นับถอยหลังสู่วันสอบสำคัญ</p></div>
                </div>
                <div class="relative inline-block w-14 align-middle select-none">
                    <input type="checkbox" id="cdActive" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 border-slate-200 appearance-none cursor-pointer translate-y-[-2px] shadow-sm"/>
                    <label for="cdActive" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer"></label>
                </div>
            </div>
            
            <div class="relative z-10 grid md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1">หัวข้อการนับถอยหลัง</label>
                    <div class="relative">
                        <input type="text" id="cdTitle" class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-orange-500 outline-none transition font-medium text-slate-700" placeholder="เช่น A-Level Exam">
                        <i data-lucide="type" class="w-4 h-4 absolute left-3.5 top-3.5 text-slate-400"></i>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1">วัน-เวลา เป้าหมาย</label>
                    <div class="relative">
                        <input type="datetime-local" id="cdDate" class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-orange-500 outline-none transition font-medium text-slate-700">
                        <i data-lucide="calendar" class="w-4 h-4 absolute left-3.5 top-3.5 text-slate-400"></i>
                    </div>
                </div>
            </div>

            <div class="relative z-10 bg-orange-50 p-6 rounded-2xl border border-orange-100">
                <label class="block text-xs font-bold text-orange-600 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i data-lucide="users" class="w-3 h-3"></i> แสดงผลเฉพาะระดับชั้น (Audience)
                </label>
                <div class="flex flex-wrap gap-4" id="gradeSelection">
                    <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border border-slate-200 hover:border-orange-300 transition shadow-sm select-none">
                        <input type="checkbox" value="M1" class="custom-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-bold text-slate-600">ม.1</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border border-slate-200 hover:border-orange-300 transition shadow-sm select-none">
                        <input type="checkbox" value="M2" class="custom-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-bold text-slate-600">ม.2</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border border-slate-200 hover:border-orange-300 transition shadow-sm select-none">
                        <input type="checkbox" value="M3" class="custom-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-bold text-slate-600">ม.3</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border border-slate-200 hover:border-orange-300 transition shadow-sm select-none">
                        <input type="checkbox" value="M4" class="custom-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-bold text-slate-600">ม.4</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border border-slate-200 hover:border-orange-300 transition shadow-sm select-none">
                        <input type="checkbox" value="M5" class="custom-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-bold text-slate-600">ม.5</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border border-slate-200 hover:border-orange-300 transition shadow-sm select-none">
                        <input type="checkbox" value="M6" class="custom-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-bold text-slate-600">ม.6</span>
                    </label>
                </div>
            </div>
        </section>

      </div>
    </main>
  </div>

  <script>
    lucide.createIcons();
    const API = "https://edtech-api-zigm.onrender.com";
    const token = localStorage.getItem("token");
    if(!token) location.href = "./login.html";

    let currentBanners = [];

    async function loadSettings() {
        try {
            const res = await fetch(`${API}/settings`);
            const s = await res.json();
            
            document.getElementById("bannerActive").checked = s.banner_active === "true";
            document.getElementById("bannerText").value = s.banner_text || "";

            document.getElementById("imgBannerActive").checked = s.image_banner_active === "true";
            document.getElementById("bannerInterval").value = s.banner_interval || 5;
            
            try { currentBanners = JSON.parse(s.banner_images); } catch { currentBanners = []; }
            renderBanners();

            document.getElementById("cdActive").checked = s.countdown_active === "true";
            document.getElementById("cdTitle").value = s.countdown_title || "";
            if(s.countdown_date) document.getElementById("cdDate").value = s.countdown_date.substring(0,16);

            // Load Audience
            let audience = ["M1","M2","M3","M4","M5","M6"];
            try { if(s.countdown_audience) audience = JSON.parse(s.countdown_audience); } catch {}
            
            document.querySelectorAll("#gradeSelection input").forEach(cb => {
                cb.checked = audience.includes(cb.value);
            });

        } catch(e) { console.error(e); }
    }

    function renderBanners() {
        const list = document.getElementById("bannerList");
        if(currentBanners.length === 0) {
            list.innerHTML = `<div class="col-span-4 text-center py-8 text-slate-400 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">ยังไม่มีรูปภาพแบนเนอร์</div>`;
            return;
        }
        list.innerHTML = currentBanners.map(url => `
            <div class="relative group aspect-video bg-slate-100 rounded-2xl overflow-hidden shadow-sm border border-slate-100">
                <img src="${url.startsWith('http') ? url : API+url}" class="w-full h-full object-cover transition duration-500 group-hover:scale-105">
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2">
                    <button onclick="removeBanner('${url}')" class="bg-white/20 hover:bg-red-500 text-white p-2 rounded-full backdrop-blur-md transition transform hover:scale-110">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        `).join("");
        lucide.createIcons();
    }

    async function uploadBanner() {
        const file = document.getElementById("bannerFile").files[0];
        if(!file) return;
        const fd = new FormData(); fd.append("file", file);
        
        Swal.fire({ title: 'กำลังอัปโหลด...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        
        try {
            const res = await fetch(`${API}/admin/settings/banner-image`, { method: "POST", headers: { Authorization: `Bearer ${token}` }, body: fd });
            if(res.ok) { 
                const d = await res.json(); 
                currentBanners = d.images; 
                renderBanners(); 
                Swal.close();
                Swal.fire({ icon: 'success', title: 'อัปโหลดสำเร็จ', timer: 1500, showConfirmButton: false });
            } else throw new Error();
        } catch { Swal.fire("Error", "Upload failed", "error"); }
    }

    async function removeBanner(url) {
        if(!(await Swal.fire({ title: 'ลบรูปภาพ?', icon: 'warning', showCancelButton: true })).isConfirmed) return;
        
        try {
            const res = await fetch(`${API}/admin/settings/banner-image`, { method: "DELETE", headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` }, body: JSON.stringify({ url }) });
            if(res.ok) { const d = await res.json(); currentBanners = d.images; renderBanners(); }
        } catch { Swal.fire("Error", "Delete failed", "error"); }
    }

    async function saveSettings() {
        // Get selected grades
        const selectedGrades = Array.from(document.querySelectorAll("#gradeSelection input:checked")).map(cb => cb.value);

        const body = {
            banner_active: document.getElementById("bannerActive").checked,
            banner_text: document.getElementById("bannerText").value,
            image_banner_active: document.getElementById("imgBannerActive").checked,
            banner_images: currentBanners,
            banner_interval: parseInt(document.getElementById("bannerInterval").value),
            
            countdown_active: document.getElementById("cdActive").checked,
            countdown_title: document.getElementById("cdTitle").value,
            countdown_date: document.getElementById("cdDate").value,
            countdown_audience: JSON.stringify(selectedGrades) // Save as JSON String
        };
        
        try {
            const res = await fetch(`${API}/admin/settings`, { method: "PATCH", headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` }, body: JSON.stringify(body) });
            if(res.ok) Swal.fire({ icon: 'success', title: 'บันทึกการตั้งค่าเรียบร้อย!', showConfirmButton: false, timer: 1500 });
            else throw new Error();
        } catch { Swal.fire("Error", "บันทึกไม่สำเร็จ", "error"); }
    }

    loadSettings();
  </script>
</body>
</html>