<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‚Äî Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <style> body { font-family: 'Prompt', sans-serif; } </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <div class="flex min-h-screen">
    <aside class="w-64 bg-slate-900 text-white flex flex-col fixed h-full z-20 shadow-2xl transition-all duration-300">
      <div class="h-16 flex items-center justify-center border-b border-slate-800 text-xl font-bold tracking-wider">
        <span class="text-indigo-400 mr-2 text-2xl">‚ú¶</span> Admin Panel
      </div>
      
      <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scroll">
        <a href="./admin_dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-slate-800 hover:text-white hover:translate-x-1 transition-all duration-200">
            <span class="text-xl">üìä</span> <span>Dashboard</span>
        </a>
        <a href="./admin_users.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-slate-800 hover:text-white hover:translate-x-1 transition-all duration-200">
            <span class="text-xl">üë•</span> <span>Users</span>
        </a>
        <a href="./admin_courses.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-indigo-600 text-white shadow-lg font-bold transition-all duration-200 transform translate-x-1">
            <span class="text-xl">üìö</span> <span>Courses</span>
        </a>
        <a href="./admin_exams.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-slate-800 hover:text-white hover:translate-x-1 transition-all duration-200">
            <span class="text-xl">üìù</span> <span>Exams</span>
        </a>
        <a href="./admin_payments.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-slate-800 hover:text-white hover:translate-x-1 transition-all duration-200">
            <span class="text-xl">üí∞</span> <span>Payments</span>
        </a>
        <a href="./admin_coupons.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-slate-800 hover:text-white hover:translate-x-1 transition-all duration-200">
            <span class="text-xl">üéüÔ∏è</span> <span>Coupons</span>
        </a>
        <a href="./admin_reports.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-slate-800 hover:text-white hover:translate-x-1 transition-all duration-200">
            <span class="text-xl">üö©</span> <span>Reports</span>
        </a>

        <div class="border-t border-slate-800 my-2 pt-2">
            <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">System</p>
            <a href="./admin_audit.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-slate-800 hover:text-white hover:translate-x-1 transition-all duration-200">
                <span class="text-xl">üõ°Ô∏è</span> <span>Audit Log</span>
            </a>
            <a href="./admin_settings.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-slate-800 hover:text-white hover:translate-x-1 transition-all duration-200">
                <span class="text-xl">‚öôÔ∏è</span> <span>Settings</span>
            </a>
        </div>
      </nav>

      <div class="p-4 border-t border-slate-800">
        <button onclick="localStorage.removeItem('token');location.href='./login.html'" class="w-full py-3 bg-slate-800 hover:bg-red-600/90 text-slate-300 hover:text-white rounded-xl transition-all duration-200 font-bold flex items-center justify-center gap-2 group">
            <span>üö™</span> <span class="group-hover:translate-x-1 transition-transform">Logout</span>
        </button>
      </div>
    </aside>

    <main class="flex-1 ml-64 p-8">
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-3xl font-bold text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
          <p class="text-slate-500 text-sm mt-1">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏•‡∏ö ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
        </div>
        <button onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl shadow-md transition flex items-center gap-2 font-bold">
          <span>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÉ‡∏´‡∏°‡πà</span>
        </button>
      </div>

      <div id="courseList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </main>
  </div>

  <dialog id="courseModal" class="rounded-2xl shadow-2xl p-0 w-full max-w-2xl backdrop:bg-slate-900/50">
    <div class="bg-white">
      <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
        <h3 class="font-bold text-lg text-slate-800" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÉ‡∏´‡∏°‡πà</h3>
        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl font-bold leading-none">&times;</button>
      </div>
      <form onsubmit="handleFormSubmit(event)" class="p-6 space-y-4">
        <input type="hidden" id="courseId">
        
        <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2">
                <label class="block text-sm font-bold text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™ <span class="text-red-500">*</span></label>
                <input type="text" id="cTitle" class="w-full border border-slate-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏∞‡∏•‡∏∏‡∏¢‡πÇ‡∏à‡∏ó‡∏¢‡πå A-Level">
            </div>
            
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                <input type="number" id="cPrice" class="w-full border border-slate-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="0 = ‡∏ü‡∏£‡∏µ">
            </div>

            <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤</label>
                <select id="cCategory" class="w-full border border-slate-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none bg-white cursor-pointer">
                    <option value="Math">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (Math)</option>
                    <option value="Physics">‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå (Physics)</option>
                    <option value="Others">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Others)</option>
                </select>
            </div>
            
            <div class="col-span-2">
                <label class="block text-sm font-bold text-slate-700 mb-1">‡∏£‡∏π‡∏õ‡∏õ‡∏Å (URL)</label>
                <input type="text" id="cThumb" class="w-full border border-slate-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="https://...">
            </div>
        </div>

        <div>
            <label class="block text-sm font-bold text-slate-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏£‡πå‡∏™</label>
            <textarea id="cDesc" rows="3" class="w-full border border-slate-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤..."></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">üéØ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£</label>
                <textarea id="cTarget" rows="3" class="w-full border border-slate-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
            </div>
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">‚ú® ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏™</label>
                <textarea id="cHigh" rows="3" class="w-full border border-slate-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
            </div>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 mt-4">
            <button type="button" onclick="closeModal()" class="px-5 py-2.5 text-slate-500 hover:bg-slate-100 rounded-xl transition font-bold text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-md transition text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </form>
    </div>
  </dialog>

  <dialog id="chapterModal" class="rounded-2xl shadow-2xl p-0 w-full max-w-6xl h-[85vh] backdrop:bg-slate-900/50">
    <div class="bg-white h-full flex flex-col">
        <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-white shrink-0">
            <div>
                <h3 class="font-bold text-xl text-slate-800" id="chapModalTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <p class="text-xs text-slate-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ (‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ)</p>
            </div>
            <button onclick="document.getElementById('chapterModal').close()" class="text-slate-400 hover:text-red-500 text-2xl font-bold p-2 leading-none">&times;</button>
        </div>
        
        <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
            <div class="w-full md:w-80 border-r border-slate-200 flex flex-col bg-slate-50">
                <div class="p-4 border-b border-slate-200 bg-white shadow-sm z-10 shrink-0">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <div class="flex gap-2">
                        <input type="text" id="newChapTitle" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." onkeypress="if(event.key==='Enter') addChapter()">
                        <button onclick="addChapter()" class="bg-indigo-600 text-white px-3 py-2 rounded-lg hover:bg-indigo-700 transition font-bold shadow-sm">+</button>
                    </div>
                </div>
                <div id="chapterList" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll"></div>
            </div>

            <div class="flex-1 flex flex-col bg-white relative">
                <div id="lessonArea" class="flex-1 flex flex-col h-full hidden">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                        <div>
                            <span class="text-xs text-indigo-500 font-bold uppercase tracking-wider">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                            <h4 class="font-bold text-xl text-slate-800" id="currentChapterName">...</h4>
                        </div>
                        <button onclick="deleteChapter(currentChapterId)" class="text-xs text-red-500 hover:text-red-700 font-medium hover:underline">‡∏•‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</button>
                    </div>

                    <div class="px-6 py-4 bg-slate-50 border-b border-slate-200 shrink-0 transition-all" id="lessonFormContainer">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-xs font-bold text-slate-700 uppercase tracking-wider flex items-center gap-2">
                                <span id="formModeText">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏´‡∏°‡πà</span>
                                <span id="editIndicator" class="hidden bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-[10px]">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
                            </label>
                            <button id="cancelEditBtn" onclick="resetForm()" class="hidden text-xs text-slate-400 hover:text-slate-600 underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        </div>
                        
                        <input type="hidden" id="editingLessonId"> <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                            <div class="md:col-span-4">
                                <input type="text" id="newLesTitle" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô EP.1 ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß)" onkeypress="if(event.key==='Enter') saveLesson()">
                            </div>
                            <div class="md:col-span-3">
                                <input type="text" id="newLesYoutube" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="YouTube URL" onkeypress="if(event.key==='Enter') saveLesson()">
                            </div>
                            <div class="md:col-span-3">
                                <input type="text" id="newLesDoc" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ URL (Optional)" onkeypress="if(event.key==='Enter') saveLesson()">
                            </div>
                            <div class="md:col-span-2">
                                <button id="saveLessonBtn" onclick="saveLesson()" class="w-full py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold rounded-lg shadow-sm transition flex items-center justify-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="lessonList" class="flex-1 overflow-y-auto p-6 space-y-2 custom-scroll bg-slate-50/30"></div>
                </div>

                <div id="lessonEmpty" class="flex-1 flex flex-col items-center justify-center text-slate-400 bg-slate-50/50">
                    <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-sm mb-4">
                        <svg class="w-10 h-10 text-indigo-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    </div>
                    <p class="font-medium text-slate-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</p>
                </div>
            </div>
        </div>
    </div>
  </dialog>

  <script>
    const API = "https://edtech-api-zigm.onrender.com";
    const token = localStorage.getItem("token");
    if(!token) location.href = "./login.html";

    let currentCourseId = null;
    let currentChapterId = null;
    let lessonsCache = [];
    let sortable = null;

    async function loadCourses() {
        try {
            const res = await fetch(`${API}/courses`);
            const courses = await res.json();
            document.getElementById("courseList").innerHTML = courses.map(c => `
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-lg transition group">
                    <div class="h-40 bg-slate-200 relative overflow-hidden">
                        ${c.thumbnail ? `<img src="${c.thumbnail}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">` : `<div class="flex items-center justify-center h-full text-slate-400">No Image</div>`}
                        <div class="absolute top-2 right-2 bg-white/90 px-2 py-1 rounded text-xs font-bold shadow-sm">${c.price > 0 ? c.price.toLocaleString()+' ‡∏ø' : 'Free'}</div>
                        <span class="absolute bottom-2 left-2 px-2 py-0.5 bg-black/50 text-white text-[10px] rounded backdrop-blur-sm">${c.category || 'General'}</span>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-lg text-slate-800 mb-1 truncate">${c.title}</h3>
                        <p class="text-sm text-slate-500 mb-4 line-clamp-2">${c.description || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢"}</p>
                        <div class="flex gap-2">
                            <button onclick="openChapterManager(${c.id}, '${c.title}')" class="flex-1 py-2 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold hover:bg-indigo-100 transition">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                            <button onclick='editCourse(${JSON.stringify(c).replace(/'/g, "&#39;")})' class="p-2 text-slate-400 hover:text-indigo-600 bg-slate-50 hover:bg-white border border-slate-100 rounded-lg transition">‚úèÔ∏è</button>
                            <button onclick="deleteCourse(${c.id})" class="p-2 text-slate-400 hover:text-red-600 bg-slate-50 hover:bg-white border border-slate-100 rounded-lg transition">üóë</button>
                        </div>
                    </div>
                </div>
            `).join("");
        } catch(e) { console.error(e); }
    }

    function openModal() {
        document.getElementById("modalTitle").innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÉ‡∏´‡∏°‡πà";
        document.getElementById("courseId").value = "";
        document.querySelector("form").reset();
        document.getElementById("courseModal").showModal();
    }
    function closeModal() { document.getElementById("courseModal").close(); }

    function editCourse(c) {
        document.getElementById("modalTitle").innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≠‡∏£‡πå‡∏™";
        document.getElementById("courseId").value = c.id;
        document.getElementById("cTitle").value = c.title;
        document.getElementById("cDesc").value = c.description || "";
        document.getElementById("cPrice").value = c.price;
        document.getElementById("cThumb").value = c.thumbnail || "";
        document.getElementById("cCategory").value = c.category || "Math"; 
        document.getElementById("cTarget").value = c.target_audience || "";
        document.getElementById("cHigh").value = c.highlights || "";
        document.getElementById("courseModal").showModal();
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const cid = document.getElementById("courseId").value;
        const body = {
            title: document.getElementById("cTitle").value,
            description: document.getElementById("cDesc").value,
            price: parseFloat(document.getElementById("cPrice").value) || 0,
            thumbnail: document.getElementById("cThumb").value,
            category: document.getElementById("cCategory").value,
            target_audience: document.getElementById("cTarget").value,
            highlights: document.getElementById("cHigh").value
        };

        const url = cid ? `${API}/admin/courses/${cid}` : `${API}/admin/courses`;
        const method = cid ? "PATCH" : "POST";
        
        const res = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify(body)
        });

        if(res.ok) {
            Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
            closeModal();
            loadCourses();
        } else {
            Swal.fire("Error", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
        }
    }

    async function deleteCourse(id) {
        if(!confirm("‡∏•‡∏ö?")) return;
        await fetch(`${API}/admin/courses/${id}`, { method: "DELETE", headers: { Authorization: `Bearer ${token}` } });
        loadCourses();
    }

    // Chapter & Lesson Logic (same as before)
    function openChapterManager(cid, t) { currentCourseId=cid; document.getElementById("chapModalTitle").innerText=t; document.getElementById("chapterModal").showModal(); loadChapters(); document.getElementById("lessonArea").classList.add("hidden"); document.getElementById("lessonEmpty").classList.remove("hidden"); }
    async function loadChapters() { const res=await fetch(`${API}/courses/${currentCourseId}`,{headers:{Authorization:`Bearer ${token}`}}); const d=await res.json(); document.getElementById("chapterList").innerHTML=d.chapters.sort((a,b)=>a.order-b.order).map(c=>`<div onclick="selectChapter(${c.id}, '${c.title}')" class="p-3 rounded-lg cursor-pointer transition border border-transparent group ${currentChapterId===c.id?'bg-indigo-50 border-indigo-100 text-indigo-700 shadow-sm':'hover:bg-white text-slate-700'}"><div class="flex justify-between font-bold text-sm"><span>${c.title}</span><button onclick="event.stopPropagation();deleteChapter(${c.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100">√ó</button></div></div>`).join(""); }
    async function addChapter() { const t=document.getElementById("newChapTitle").value; if(t) await fetch(`${API}/admin/courses/${currentCourseId}/chapters`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify({title:t,order:99})}); document.getElementById("newChapTitle").value=""; loadChapters(); }
    function selectChapter(cid, t) { currentChapterId=cid; document.getElementById("currentChapterName").innerText=t; document.getElementById("lessonEmpty").classList.add("hidden"); document.getElementById("lessonArea").classList.remove("hidden"); resetForm(); loadLessons(cid); }
    async function loadLessons(cid) { const res=await fetch(`${API}/courses/${currentCourseId}`,{headers:{Authorization:`Bearer ${token}`}}); const d=await res.json(); const ch=d.chapters.find(c=>c.id===cid); lessonsCache=ch?ch.lessons.sort((a,b)=>a.order-b.order):[]; renderLessonList(); }
    function renderLessonList() { document.getElementById("lessonList").innerHTML=lessonsCache.map((l,i)=>`<div class="flex items-center gap-4 p-3 bg-white rounded-xl border border-slate-100 hover:border-indigo-200 shadow-sm group" data-id="${l.id}"><div class="handle w-8 h-8 bg-slate-50 flex items-center justify-center text-slate-400 border border-slate-100 rounded cursor-move">‚ò∞</div><div class="flex-1"><div class="font-bold text-slate-700">${l.title}</div></div><div class="flex gap-2 opacity-0 group-hover:opacity-100"><button onclick='populateEditForm(${JSON.stringify(l).replace(/'/g,"&#39;")})' class="text-slate-400 hover:text-indigo-600">‚úé</button><button onclick="deleteLesson(${l.id})" class="text-slate-400 hover:text-red-600">üóë</button></div></div>`).join(""); if(sortable) sortable.destroy(); sortable=new Sortable(document.getElementById("lessonList"),{handle:".handle",animation:150,onEnd:updateLessonOrder}); }
    async function saveLesson() { const id=document.getElementById("editingLessonId").value, t=document.getElementById("newLesTitle").value, y=document.getElementById("newLesYoutube").value, d=document.getElementById("newLesDoc").value; if(!t||!y) return Swal.fire("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô","‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö","warning"); const m=id?"PATCH":"POST", u=id?`${API}/admin/lessons/${id}`:`${API}/admin/chapters/${currentChapterId}/lessons`; await fetch(u,{method:m,headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify({title:t,youtube_id:y,doc_url:d,duration:0})}); resetForm(); loadLessons(currentChapterId); }
    function populateEditForm(l) { document.getElementById("editingLessonId").value=l.id; document.getElementById("newLesTitle").value=l.title; document.getElementById("newLesYoutube").value=l.youtube_id; document.getElementById("newLesDoc").value=l.doc_url||""; document.getElementById("formModeText").innerText="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠"; document.getElementById("editIndicator").classList.remove("hidden"); document.getElementById("cancelEditBtn").classList.remove("hidden"); document.getElementById("saveLessonBtn").innerHTML="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"; document.getElementById("newLesTitle").focus(); }
    function resetForm() { document.getElementById("editingLessonId").value=""; document.getElementById("newLesTitle").value=""; document.getElementById("newLesYoutube").value=""; document.getElementById("newLesDoc").value=""; document.getElementById("formModeText").innerText="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏´‡∏°‡πà"; document.getElementById("editIndicator").classList.add("hidden"); document.getElementById("cancelEditBtn").classList.add("hidden"); document.getElementById("saveLessonBtn").innerHTML="‡πÄ‡∏û‡∏¥‡πà‡∏°"; }
    async function deleteLesson(id) { if(confirm("‡∏•‡∏ö?")) { await fetch(`${API}/admin/lessons/${id}`,{method:"DELETE",headers:{Authorization:`Bearer ${token}`}}); loadLessons(currentChapterId); } }
    async function deleteChapter(id) { if(confirm("‡∏•‡∏ö?")) { alert("API Delete Chapter Not Implemented Yet"); } }
    async function updateLessonOrder() { const items=document.querySelectorAll("#lessonList > div"); for(let i=0;i<items.length;i++) { await fetch(`${API}/admin/lessons/${items[i].dataset.id}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify({order:i})}); } }

    loadCourses();
  </script>
</body>
</html>