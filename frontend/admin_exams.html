<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‚Äî Admin</title><script src="https://cdn.tailwindcss.com"></script>
  <style>.admin-gradient{background:linear-gradient(135deg,#111827 0%,#1e1b4b 100%)}dialog::backdrop{background:rgba(0,0,0,0.5);backdrop-filter:blur(2px)}</style>
</head>
<body class="min-h-screen bg-slate-100 font-sans text-slate-800">
  <header class="admin-gradient text-white shadow-md sticky top-0 z-50">
    <nav class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between relative">
      <a href="./admin_users.html" class="flex items-center gap-3 group relative z-10"><img src="http://127.0.0.1:8000/static/logo.png" alt="Logo" class="h-12 w-auto object-contain bg-white/10 rounded p-1"><div class="leading-tight"><div class="font-bold text-lg">ADMIN CONSOLE</div></div></a>
      <div class="relative bg-white/10 p-1.5 rounded-xl hidden md:flex items-center gap-1">
        <div id="nav-slider" class="absolute h-[calc(100%-12px)] top-1.5 bg-white/20 rounded-lg transition-all duration-300 ease-out opacity-0 pointer-events-none z-0"></div>
        <a href="./admin_users.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="users">üë• Users</a>
        <a href="./admin_courses.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="courses">üìö Courses</a>
        <a href="./admin_payments.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="payments">üí∞ Payments</a>
        <a href="./admin_exams.html" class="nav-link px-4 py-2 rounded-lg text-sm font-bold text-slate-300 hover:text-white relative z-10 transition-colors" data-page="exams">üìù Exams</a>
        <a href="./admin_audit.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="audit">üõ°Ô∏è Logs</a>
      </div>
      <div class="flex items-center gap-4 relative z-10"><a href="./me.html" class="text-xs text-slate-300 hover:text-white border-b border-transparent hover:border-slate-300 transition">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a><button onclick="logout()" class="text-xs bg-red-500/20 hover:bg-red-500 text-red-100 px-3 py-1.5 rounded transition">Logout</button></div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-6">
    <div class="flex items-center justify-between"><h1 class="text-3xl font-bold text-slate-900">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (Mock Exam)</h1><button onclick="document.getElementById('createExamDlg').showModal()" class="px-4 py-2 bg-black text-white rounded-lg text-sm shadow hover:bg-gray-800">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button></div>
    <div id="examList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"><div class="col-span-full text-center py-10 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
  </main>

  <dialog id="createExamDlg" class="p-0 rounded-2xl shadow-2xl w-[450px] overflow-hidden"><div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center"><h3 class="font-bold text-lg">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</h3><button onclick="document.getElementById('createExamDlg').close()" class="text-slate-400 hover:text-white">‚úï</button></div><form id="createExamForm" class="bg-white p-6 space-y-4"><div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</label><input name="title" required class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô TGAT1 ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 1"></div><div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea name="description" class="w-full border rounded-lg px-3 py-2 text-sm"></textarea></div><div><label class="block text-xs font-bold text-slate-500 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö (‡∏ô‡∏≤‡∏ó‡∏µ)</label><input type="number" name="time_limit" value="60" required class="w-full border rounded-lg px-3 py-2 text-sm"></div><div class="flex justify-end gap-2 pt-2"><button type="submit" class="w-full px-3 py-2 text-sm bg-slate-900 text-white rounded-lg hover:bg-slate-800 shadow-lg">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢</button></div></form></dialog>
  <dialog id="questionsDlg" class="p-0 rounded-2xl shadow-2xl w-[800px] h-[90vh] overflow-hidden flex flex-col"><div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center"><h3 class="font-bold text-lg" id="qDlgTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏ó‡∏¢‡πå</h3><button onclick="document.getElementById('questionsDlg').close()" class="text-slate-400 hover:text-white">‚úï</button></div><div class="flex-1 overflow-y-auto p-6 space-y-6 bg-white"><div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100"><h4 class="font-bold text-indigo-900 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà</h4><form id="addQForm" class="space-y-3"><textarea name="text" required class="w-full border rounded p-2 text-sm" rows="2" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..."></textarea><div class="grid grid-cols-2 gap-2"><div class="flex gap-2 items-center"><input type="radio" name="correct" value="0" checked><input name="c0" required class="w-full border rounded px-2 py-1 text-sm" placeholder="‡∏Å. ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1"></div><div class="flex gap-2 items-center"><input type="radio" name="correct" value="1"><input name="c1" required class="w-full border rounded px-2 py-1 text-sm" placeholder="‡∏Ç. ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2"></div><div class="flex gap-2 items-center"><input type="radio" name="correct" value="2"><input name="c2" required class="w-full border rounded px-2 py-1 text-sm" placeholder="‡∏Ñ. ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3"></div><div class="flex gap-2 items-center"><input type="radio" name="correct" value="3"><input name="c3" required class="w-full border rounded px-2 py-1 text-sm" placeholder="‡∏á. ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 4"></div></div><button class="w-full bg-indigo-600 text-white rounded py-1.5 text-sm hover:bg-indigo-700 font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ</button></form></div><div id="qList" class="space-y-4"></div></div></dialog>

  <script>
    const page="exams"; const slider=document.getElementById("nav-slider"); const links=document.querySelectorAll(".nav-link"); let activeLink=null;
    links.forEach(link=>{ if(link.dataset.page===page){activeLink=link;link.classList.add("text-white");moveSlider(link);slider.style.opacity="1";} link.addEventListener("mouseenter",(e)=>{moveSlider(e.target);slider.style.opacity="1";});});
    document.querySelector(".relative.bg-white\\/10").addEventListener("mouseleave",()=>{if(activeLink)moveSlider(activeLink);else slider.style.opacity="0";});
    function moveSlider(el){slider.style.width=el.offsetWidth+"px";slider.style.left=el.offsetLeft+"px";}

    const API = (window.location.hostname==="127.0.0.1"||window.location.hostname==="localhost")?"http://127.0.0.1:8000":"https://edtech-api-zigm.onrender.com";
    const token = localStorage.getItem("token");
    if(!token) location.href="./login.html";
    function logout(){ localStorage.removeItem("token"); location.href="./login.html"; }

    async function loadExams(){ const res = await fetch(`${API}/exams`); const list = await res.json(); renderExams(list); }
    function renderExams(list){
      if(list.length===0){ document.getElementById("examList").innerHTML = `<div class="col-span-full text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</div>`; return; }
      document.getElementById("examList").innerHTML = list.map(ex => `<div class="bg-white border rounded-xl p-5 hover:shadow-md transition flex flex-col"><div class="flex justify-between items-start mb-2"><div><h3 class="font-bold text-lg text-slate-800">${ex.title}</h3><p class="text-xs text-slate-500 mt-1">${ex.description||"-"}</p></div><button onclick="openQuestions(${ex.id}, '${ex.title}')" class="px-3 py-1.5 border border-indigo-200 text-indigo-700 rounded text-xs font-bold hover:bg-indigo-50">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏ó‡∏¢‡πå</button></div><div class="mt-auto pt-3 border-t border-slate-50 flex gap-2 text-xs text-slate-400"><span>‚è≥ ${ex.time_limit} ‡∏ô‡∏≤‡∏ó‡∏µ</span><span>üìù ${ex.questions?ex.questions.length:0} ‡∏Ç‡πâ‡∏≠</span></div></div>`).join("");
    }
    document.getElementById("createExamForm").onsubmit = async (e)=>{ e.preventDefault(); const form = e.target; try { const res = await fetch(`${API}/admin/exams`, { method:"POST", headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` }, body: JSON.stringify({ title: form.title.value, description: form.description.value, time_limit: form.time_limit.value }) }); if(!res.ok) throw new Error("Failed"); form.reset(); document.getElementById("createExamDlg").close(); loadExams(); } catch(err){ alert(err.message); } };
    let currentExamId = null;
    async function openQuestions(id, title){ currentExamId = id; document.getElementById("qDlgTitle").textContent = `‡πÇ‡∏à‡∏ó‡∏¢‡πå: ${title}`; document.getElementById("questionsDlg").showModal(); loadQuestions(id); }
    async function loadQuestions(id){ const res = await fetch(`${API}/exams/${id}`, { headers:{ Authorization:`Bearer ${token}` } }); const data = await res.json(); renderQuestions(data.questions || []); }
    function renderQuestions(qs){ qs.sort((a,b)=> a.order - b.order); document.getElementById("qList").innerHTML = qs.map((q, idx) => `<div class="border p-4 rounded-xl bg-slate-50"><div class="font-bold text-sm mb-3 text-slate-700">‡∏Ç‡πâ‡∏≠ ${idx+1}) ${q.text}</div><div class="grid grid-cols-2 gap-2 text-xs">${q.choices.map(c => `<div class="p-2 border rounded bg-white ${c.is_correct?'border-green-500 text-green-700 font-bold bg-green-50':''}">${c.text}</div>`).join("")}</div></div>`).join(""); }
    document.getElementById("addQForm").onsubmit = async (e)=>{ e.preventDefault(); const f = e.target; const correctIdx = parseInt(f.correct.value); const choices = [ { text: f.c0.value, is_correct: correctIdx===0 }, { text: f.c1.value, is_correct: correctIdx===1 }, { text: f.c2.value, is_correct: correctIdx===2 }, { text: f.c3.value, is_correct: correctIdx===3 }, ]; const payload = { text: f.text.value, order: document.getElementById("qList").children.length + 1, choices: choices }; try { const res = await fetch(`${API}/admin/exams/${currentExamId}/questions`, { method:"POST", headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` }, body: JSON.stringify(payload) }); if(!res.ok) throw new Error("Failed"); f.reset(); f.correct[0].checked = true; loadQuestions(currentExamId); } catch(err){ alert(err.message); } };
    loadExams();
  </script>
</body>
</html>