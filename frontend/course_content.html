<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏≠‡∏£‡πå‡∏™ ‚Äî MingSmileyFace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; }
    
    /* Glass Effect */
    .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.6); }
    .glass-card { background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(255, 255, 255, 0.6); }
    
    /* Card Styles */
    .chapter-btn.active { 
        background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; border: none;
        box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4); transform: scale(1.02);
    }
    .chapter-btn:hover:not(.active) { background-color: white; }
    
    .lesson-card { transition: all 0.3s ease; border: 1px solid transparent; }
    .lesson-card:hover { 
        transform: translateY(-2px); 
        background: white;
        border-color: #e0e7ff;
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05); 
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  </style>
</head>
<body class="min-h-screen text-slate-800 flex flex-col bg-[url('https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&w=2000&q=80')] bg-fixed bg-cover">
  <div class="fixed inset-0 bg-slate-50/90 backdrop-blur-3xl -z-10"></div>

  <nav class="fixed w-full z-50 transition-all duration-300 glass shadow-sm">
    <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
      <div class="flex items-center gap-4">
        <a href="./me.html" class="p-2 hover:bg-slate-100/50 rounded-full transition text-slate-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
        </a>
        <h1 class="font-bold text-lg text-slate-800 truncate max-w-xs md:max-w-md" id="navTitle">Loading...</h1>
      </div>
      <div class="hidden md:flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs border border-indigo-200" id="navAvatar">U</div>
      </div>
    </div>
  </nav>
  <div class="h-16"></div>

  <div class="max-w-7xl mx-auto px-4 py-8 w-full">
    <div class="glass rounded-3xl p-6 md:p-8 shadow-xl relative overflow-hidden">
      <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
      <div class="absolute bottom-0 left-0 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl -ml-16 -mb-16 pointer-events-none"></div>

      <div class="relative z-10 flex flex-col lg:flex-row gap-8 lg:gap-10">
        
        <div class="flex-1 min-w-0">
           <div class="flex flex-col md:flex-row gap-8 items-start">
              <div class="w-full md:w-5/12 shrink-0">
                 <div class="aspect-video w-full rounded-2xl overflow-hidden shadow-lg border border-white/60">
                    <img id="courseThumb" src="" class="w-full h-full object-cover">
                 </div>
              </div>
              
              <div class="flex-1 w-full flex flex-col h-full justify-center">
                 <div class="inline-block px-2.5 py-1 rounded bg-indigo-50 text-indigo-600 text-[10px] font-bold mb-3 border border-indigo-100 w-fit">COURSE OVERVIEW</div>
                 <h1 id="courseTitle" class="text-3xl md:text-4xl font-black text-slate-800 mb-4 leading-tight">...</h1>
                 <p id="courseDesc" class="text-slate-500 text-sm leading-relaxed mb-6 line-clamp-3">...</p>
                 
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-auto">
                     <div id="boxTarget" class="hidden glass-card p-3 rounded-xl flex items-start gap-3 hover:bg-white/40 transition">
                         <div class="bg-indigo-100 p-1.5 rounded-lg text-lg shrink-0">üéØ</div>
                         <div>
                             <h4 class="text-[10px] font-bold text-indigo-600 uppercase mb-0.5">‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö</h4>
                             <p id="cTarget" class="text-xs text-slate-600 leading-snug line-clamp-2">-</p>
                         </div>
                     </div>
                     <div id="boxHigh" class="hidden glass-card p-3 rounded-xl flex items-start gap-3 hover:bg-white/40 transition">
                         <div class="bg-emerald-100 p-1.5 rounded-lg text-lg shrink-0">‚ú®</div>
                         <div>
                             <h4 class="text-[10px] font-bold text-emerald-600 uppercase mb-0.5">‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô</h4>
                             <p id="cHigh" class="text-xs text-slate-600 leading-snug line-clamp-2">-</p>
                         </div>
                     </div>
                 </div>
              </div>
           </div>
        </div>

        <div class="hidden lg:block w-px bg-slate-300 self-stretch my-2 opacity-70"></div>
        <div class="block lg:hidden h-px bg-slate-300 w-full my-4 opacity-70"></div>

        <div class="w-full lg:w-72 shrink-0 flex flex-col justify-center">
           
           <div class="mb-6">
               <h3 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2 flex justify-between">
                   <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                   <span class="text-indigo-500">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
               </h3>
               <div class="flex items-baseline gap-2 mb-3">
                   <span id="mainProgText" class="text-5xl font-black text-slate-800 tracking-tight">0%</span>
                   <span class="text-slate-400 text-sm font-medium">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>
               </div>
               <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden shadow-inner border border-slate-200">
                   <div id="mainProgBar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-1000 relative" style="width: 0%">
                       <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                   </div>
               </div>
           </div>

           <a id="btnStart" href="#" class="w-full inline-flex items-center justify-center gap-2 px-6 py-3.5 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:bg-slate-800 hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 mb-6 group">
               <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
               <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
           </a>

           <div class="grid grid-cols-2 gap-3">
               <div class="bg-white/60 p-3 rounded-xl border border-white/80 text-center shadow-sm">
                   <div class="text-indigo-500 text-lg mb-1">‚è≥</div>
                   <div class="font-bold text-slate-700 text-sm" id="totalDurationBadge">--</div>
                   <div class="text-[9px] text-slate-400 uppercase font-bold">‡∏ô‡∏≤‡∏ó‡∏µ</div>
               </div>
               <div class="bg-white/60 p-3 rounded-xl border border-white/80 text-center shadow-sm">
                   <div class="text-purple-500 text-lg mb-1">üìö</div>
                   <div class="font-bold text-slate-700 text-sm" id="totalLessonsBadge">--</div>
                   <div class="text-[9px] text-slate-400 uppercase font-bold">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
               </div>
           </div>
        </div>

      </div>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 pb-20 flex-1 w-full">
    <div class="flex flex-col lg:flex-row gap-8 items-start">
      
      <aside class="w-full lg:w-80 lg:order-1 lg:sticky lg:top-24 space-y-4">
        <div class="glass rounded-2xl p-4 shadow-lg border-white/60">
          <h3 class="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wide flex items-center gap-2 px-1">
            <span class="bg-indigo-100 text-indigo-600 p-1 rounded">üìñ</span> ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
          </h3>
          <div id="chapterList" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1 custom-scroll">
             </div>
        </div>
      </aside>

      <section class="flex-1 w-full lg:order-2 min-h-[50vh]">
        <div class="glass rounded-3xl p-6 md:p-8 shadow-lg border-white/60">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                        <span id="currentChapterTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                    </h2>
                    <p class="text-sm text-slate-400 mt-1 pl-1" id="lessonCountBadge">0 ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                </div>
            </div>
            
            <div id="lessonArea" class="grid gap-3">
                <div class="text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50">
                    <div class="text-4xl mb-3 opacity-50">üëà</div>
                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢</p>
                </div>
            </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const API = (window.location.hostname==="127.0.0.1"||window.location.hostname==="localhost")?"https://edtech-api-zigm.onrender.com":"https://edtech-api-zigm.onrender.com";
    const token = localStorage.getItem("token");
    if (!token) location.href = "./login.html";

    const courseId = new URLSearchParams(window.location.search).get("id");
    if(!courseId) location.href = "./me.html";

    let courseData = null, completedSet = new Set();
    let currentChapterId = null;

    async function init(){
      try {
        const [cRes, pRes, uRes] = await Promise.all([
            fetch(`${API}/courses/${courseId}`, { headers: { Authorization: `Bearer ${token}` }}),
            fetch(`${API}/courses/${courseId}/my-progress`, { headers: { Authorization: `Bearer ${token}` }}),
            fetch(`${API}/users/me`, { headers: { Authorization: `Bearer ${token}` }})
        ]);
        if(!cRes.ok) throw new Error();
        
        courseData = await cRes.json();
        const prog = await pRes.json();
        const user = await uRes.json();
        completedSet = new Set(prog.completed_ids);

        renderHeader(user);
        renderChapters();
        
        // Auto select first chapter
        if(courseData.chapters && courseData.chapters.length > 0) {
            selectChapter(courseData.chapters.sort((a,b)=>a.order-b.order)[0].id);
        }
      } catch(e) { console.error(e); }
    }

    function renderHeader(user){
      document.getElementById("navTitle").textContent = courseData.title;
      document.getElementById("navAvatar").textContent = user.full_name ? user.full_name[0].toUpperCase() : "U";
      
      document.getElementById("courseTitle").textContent = courseData.title;
      document.getElementById("courseDesc").textContent = courseData.description || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î";
      if(courseData.thumbnail) document.getElementById("courseThumb").src = courseData.thumbnail.startsWith("http") ? courseData.thumbnail : API + courseData.thumbnail;
      
      // ‚úÖ New Fields Logic
      if(courseData.target_audience) {
          document.getElementById("cTarget").textContent = courseData.target_audience;
          document.getElementById("boxTarget").classList.remove("hidden");
      }
      if(courseData.highlights) {
          document.getElementById("cHigh").textContent = courseData.highlights;
          document.getElementById("boxHigh").classList.remove("hidden");
      }

      // Calculate Progress
      let totalLessons = 0;
      let totalMinutes = 0;
      let firstUnwatchedLessonId = null;

      courseData.chapters.forEach(c => {
          c.lessons.sort((a,b)=>a.order-b.order).forEach(l => {
              totalLessons++;
              totalMinutes += (l.duration || 0);
              if(!completedSet.has(l.id) && !firstUnwatchedLessonId) firstUnwatchedLessonId = l.id;
          });
      });

      const pct = totalLessons > 0 ? Math.round((completedSet.size / totalLessons) * 100) : 0;
      
      // Update Stats
      document.getElementById("mainProgText").textContent = `${pct}%`;
      document.getElementById("mainProgBar").style.width = `${pct}%`;
      
      document.getElementById("totalDurationBadge").textContent = `${totalMinutes}`;
      document.getElementById("totalLessonsBadge").textContent = `${totalLessons}`;

      // Update Button State
      const btn = document.getElementById("btnStart");
      if(pct === 100) {
          btn.innerHTML = `<span>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span> <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
          btn.className = "w-full inline-flex items-center justify-center gap-2 px-6 py-3.5 bg-emerald-500 text-white font-bold rounded-xl shadow-lg cursor-default mb-6";
          btn.href = "#";
      } else {
          const targetId = firstUnwatchedLessonId || (courseData.chapters?.[0]?.lessons?.[0]?.id);
          if(targetId) {
              btn.href = `./learning_room.html?id=${courseId}&lesson=${targetId}`;
              btn.innerHTML = pct > 0 ? `<span>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠</span> <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>` : `<span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span> <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>`;
          }
      }
    }

    function renderChapters(){
      const list = document.getElementById("chapterList");
      if(!courseData.chapters || courseData.chapters.length === 0) {
        list.innerHTML = `<div class="text-xs text-slate-400 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</div>`;
        return;
      }
      
      list.innerHTML = courseData.chapters.sort((a,b)=>a.order-b.order).map((ch, idx) => {
        const total = ch.lessons.length;
        const done = ch.lessons.filter(l => completedSet.has(l.id)).length;
        const pct = total > 0 ? Math.round((done/total)*100) : 0;
        
        return `
        <button onclick="selectChapter(${ch.id})" id="chap-btn-${ch.id}" class="chapter-btn w-full text-left p-3.5 rounded-xl border border-slate-200/50 bg-white/40 hover:bg-white transition-all duration-200 group relative overflow-hidden mb-2">
            <div class="flex justify-between items-center mb-1.5 relative z-10">
                <span class="font-bold text-sm truncate pr-2 flex items-center gap-2 text-slate-700 group-hover:text-slate-900 chapter-title">
                    <span class="w-6 h-6 rounded-md bg-slate-100 text-slate-500 text-[10px] flex items-center justify-center font-bold chapter-idx">${idx+1}</span>
                    <span class="truncate w-36">${ch.title}</span>
                </span>
                <span class="text-[9px] bg-slate-100 chapter-subtitle text-slate-500 rounded px-1.5 py-0.5 font-mono border border-slate-200">${done}/${total}</span>
            </div>
            <div class="h-1 bg-slate-100 w-full rounded-full overflow-hidden progress-bar-bg">
                <div class="h-full bg-emerald-400 rounded-full progress-bar-fill transition-all duration-500" style="width: ${pct}%"></div>
            </div>
        </button>
        `;
      }).join("");
    }

    function selectChapter(chapId){
      document.querySelectorAll('.chapter-btn').forEach(b => {
          b.classList.remove('active');
          b.querySelector('.chapter-idx').className = "w-6 h-6 rounded-md bg-slate-100 text-slate-500 text-[10px] flex items-center justify-center font-bold chapter-idx";
          b.querySelector('.chapter-title').classList.remove('text-white');
      });
      const btn = document.getElementById(`chap-btn-${chapId}`);
      if(btn) {
          btn.classList.add('active');
          btn.querySelector('.chapter-idx').className = "w-6 h-6 rounded-md bg-white/20 text-white text-[10px] flex items-center justify-center font-bold chapter-idx";
          btn.querySelector('.chapter-title').classList.add('text-white');
      }

      const chapter = courseData.chapters.find(c => c.id === chapId);
      if(!chapter) return;

      document.getElementById("currentChapterTitle").textContent = chapter.title;
      document.getElementById("lessonCountBadge").textContent = `${chapter.lessons.length} ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô`;

      const area = document.getElementById("lessonArea");
      if(chapter.lessons.length === 0) { area.innerHTML = `<div class="text-center py-16 text-slate-400 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</div>`; return; }

      area.innerHTML = chapter.lessons.sort((a,b)=>a.order-b.order).map((l, i) => {
        const isDone = completedSet.has(l.id);
        const icon = isDone ? "‚úì" : "‚ñ∂";
        const iconClass = isDone ? "bg-emerald-500 text-white shadow-emerald-200" : "bg-white text-slate-400 border border-slate-200 group-hover:border-indigo-500 group-hover:text-indigo-600";

        return `
        <a href="./learning_room.html?id=${courseId}&lesson=${l.id}" class="lesson-card block bg-white/60 rounded-2xl p-4 flex items-center gap-4 group relative overflow-hidden backdrop-blur-sm">
            <div class="play-icon w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${iconClass} transition-all duration-300 shadow-sm text-sm font-bold z-10">
                ${icon}
            </div>
            <div class="flex-1 min-w-0 z-10">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-[10px] font-bold tracking-wider text-slate-400 uppercase bg-slate-100 px-2 py-0.5 rounded">EP.${i+1}</span>
                    ${l.duration ? `<span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-0.5 rounded border border-slate-200">‚è± ${l.duration}m</span>` : ''}
                    ${l.doc_url ? '<span class="text-[9px] font-bold text-blue-500 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">DOC</span>' : ''}
                </div>
                <div class="font-bold text-slate-700 text-sm truncate group-hover:text-indigo-600 transition">${l.title}</div>
            </div>
            ${isDone ? '<span class="text-xs font-bold text-emerald-500 bg-emerald-50 px-2 py-1 rounded-lg">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>' : ''}
        </a>`;
      }).join("");
    }

    init();
  </script>
</body>
</html>