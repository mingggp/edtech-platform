<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‚Äî Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .admin-gradient { background: linear-gradient(135deg,#111827 0%, #1e1b4b 100%); }
    dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    .group:hover .group-hover\:visible { visibility: visible; }
    .group:hover .group-hover\:opacity-100 { opacity: 1; }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background-color: #f8fafc; }
  </style>
</head>
<body class="min-h-screen bg-slate-100 font-sans text-slate-800">

  <header class="admin-gradient text-white shadow-md sticky top-0 z-50">
    <nav class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between relative">
      <a href="./admin_users.html" class="flex items-center gap-3 group relative z-10">
        <img src="http://127.0.0.1:8000/static/logo.png" alt="Logo" class="h-12 w-auto object-contain bg-white/10 rounded p-1">
        <div class="leading-tight"><div class="font-bold text-lg">ADMIN CONSOLE</div></div>
      </a>
      <div class="relative bg-white/10 p-1.5 rounded-xl hidden md:flex items-center gap-1">
        <div id="nav-slider" class="absolute h-[calc(100%-12px)] top-1.5 bg-white/20 rounded-lg transition-all duration-300 ease-out opacity-0 pointer-events-none z-0"></div>
        <a href="./admin_users.html" class="nav-link px-4 py-2 rounded-lg text-sm font-bold text-slate-300 hover:text-white relative z-10 transition-colors" data-page="users">üë• Users</a>
        <a href="./admin_courses.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="courses">üìö Courses</a>
        <a href="./admin_payments.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="payments">üí∞ Payments</a>
        <a href="./admin_exams.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="exams">üìù Exams</a>
        <a href="./admin_audit.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="audit">üõ°Ô∏è Logs</a>
      </div>
      <div class="flex items-center gap-4 relative z-10">
        <a href="./me.html" class="text-xs text-slate-300 hover:text-white border-b border-transparent hover:border-slate-300 transition">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
        <button onclick="logout()" class="text-xs bg-red-500/20 hover:bg-red-500 text-red-100 px-3 py-1.5 rounded transition">Logout</button>
      </div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-6">
    <div class="flex flex-col md:flex-row gap-6 justify-between items-end">
      <div>
        <h1 class="text-3xl font-bold text-slate-900">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h1>
        <p class="text-slate-500 mt-1 text-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Online ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
      </div>
      <div class="flex gap-4">
        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 min-w-[100px]">
          <div class="text-[10px] text-slate-400 uppercase font-bold">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div id="m_total" class="text-2xl font-black text-indigo-600">-</div>
        </div>
        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 min-w-[100px]">
          <div class="text-[10px] text-slate-400 uppercase font-bold">‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          <div id="m_new" class="text-2xl font-black text-emerald-500">-</div>
        </div>
      </div>
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-wrap gap-3 items-center justify-between">
      <div class="flex flex-wrap gap-2 items-center w-full md:w-auto">
        <input id="q" class="pl-3 pr-4 py-2 border rounded-lg text-sm w-56 outline-none" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Email / ‡∏ä‡∏∑‡πà‡∏≠...">
        <select id="fRole" class="border rounded-lg px-3 py-2 text-sm bg-slate-50"><option value="">‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option><option value="student">üéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option value="admin">üëë Admin</option></select>
        <select id="fActive" class="border rounded-lg px-3 py-2 text-sm bg-slate-50"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="true">‚úÖ Active</option><option value="false">‚õî Inactive</option></select>
        <select id="fGrade" class="border rounded-lg px-3 py-2 text-sm bg-slate-50"><option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option><option value="M1">M1</option><option value="M2">M2</option><option value="M3">M3</option><option value="M4">M4</option><option value="M5">M5</option><option value="M6">M6</option></select>
        <button id="btnSearch" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm hover:bg-slate-900 transition">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="flex gap-2 w-full md:w-auto justify-end">
        <button id="btnCreate" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 transition shadow-md shadow-indigo-200 flex items-center gap-2"><span>+</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</button>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
          <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-bold tracking-wider border-b border-slate-200">
            <tr>
              <th class="px-6 py-4 sortable" onclick="setSort('id')">ID <span id="sort-id" class="text-slate-300">‚Üï</span></th>
              <th class="px-6 py-4">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
              <th class="px-6 py-4 sortable" onclick="setSort('role')">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó <span id="sort-role" class="text-slate-300">‚Üï</span></th>
              <th class="px-6 py-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
              <th class="px-6 py-4 sortable" onclick="setSort('grade_level')">‡∏ä‡∏±‡πâ‡∏ô <span id="sort-grade_level" class="text-slate-300">‚Üï</span></th>
              <th class="px-6 py-4 sortable" onclick="setSort('last_login')">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <span id="sort-last_login" class="text-slate-300">‚Üì</span></th>
              <th class="px-6 py-4 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="rows" class="divide-y divide-slate-100"><tr><td colspan="7" class="px-6 py-10 text-center text-slate-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr></tbody>
        </table>
      </div>
      <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
        <div id="meta" class="text-xs text-slate-500">‡∏´‡∏ô‡πâ‡∏≤ 1</div>
        <div class="flex gap-2">
          <button id="prev" class="px-3 py-1 bg-white border border-slate-300 rounded text-xs font-bold disabled:opacity-50">Previous</button>
          <button id="next" class="px-3 py-1 bg-white border border-slate-300 rounded text-xs font-bold disabled:opacity-50">Next</button>
        </div>
      </div>
    </div>
  </main>

  <dialog id="editDlg" class="p-0 rounded-2xl shadow-2xl w-[450px] overflow-hidden">
    <div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center"><h3 class="font-bold text-lg" id="dlgTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3><button onclick="document.getElementById('editDlg').close()" class="text-slate-400 hover:text-white">‚úï</button></div>
    <form id="editForm" class="bg-white p-6 space-y-4">
      <input type="hidden" id="edit_id">
      <div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input id="edit_email" class="w-full border rounded-lg px-3 py-2 text-sm bg-slate-50 text-slate-500" disabled></div>
      <div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</label><input id="edit_full_name" class="w-full border rounded-lg px-3 py-2 text-sm"></div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label><select id="edit_role" class="w-full border rounded-lg px-3 py-2 text-sm bg-white"><option value="student">üéì Student</option><option value="admin">üëë Admin</option></select></div>
        <div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label><select id="edit_grade" class="w-full border rounded-lg px-3 py-2 text-sm bg-white"><option value="">--</option><option value="M1">M1</option><option value="M2">M2</option><option value="M3">M3</option><option value="M4">M4</option><option value="M5">M5</option><option value="M6">M6</option></select></div>
      </div>
      <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="edit_active" class="w-4 h-4 text-indigo-600 rounded"><label for="edit_active" class="text-sm text-slate-700">Account Active</label></div>
      <div class="flex gap-3 pt-4 border-t border-slate-100"><button type="button" id="btnResetPass" class="flex-1 px-3 py-2 text-xs border border-orange-200 text-orange-600 bg-orange-50 rounded-lg hover:bg-orange-100">üîë Reset Pass</button><button type="submit" class="flex-1 px-3 py-2 text-sm bg-slate-900 text-white rounded-lg hover:bg-slate-800 shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
    </form>
  </dialog>

  <script>
    const page="users"; const slider=document.getElementById("nav-slider"); const links=document.querySelectorAll(".nav-link"); let activeLink=null;
    links.forEach(link=>{ if(link.dataset.page===page){activeLink=link;link.classList.add("text-white");moveSlider(link);slider.style.opacity="1";} link.addEventListener("mouseenter",(e)=>{moveSlider(e.target);slider.style.opacity="1";});});
    document.querySelector(".relative.bg-white\\/10").addEventListener("mouseleave",()=>{if(activeLink)moveSlider(activeLink);else slider.style.opacity="0";});
    function moveSlider(el){slider.style.width=el.offsetWidth+"px";slider.style.left=el.offsetLeft+"px";}

    const API = (window.location.hostname==="127.0.0.1"||window.location.hostname==="localhost")?"http://127.0.0.1:8000":"https://edtech-api-zigm.onrender.com";
    const token = localStorage.getItem("token");
    if (!token) location.href = "./login.html";
    function logout(){ localStorage.removeItem("token"); location.href="./login.html"; }

    const tbody = document.getElementById("rows");
    let pageNum=1, pageSize=10, currentSortField="last_login", currentSortDir="desc";
    const df = new Intl.DateTimeFormat('th-TH', { dateStyle:'medium', timeStyle:'short' });
    function fmtDate(d){return d?df.format(new Date(d)):"-";}

    async function fetchJSON(url, opts={}){
      const res = await fetch(url, { ...opts, headers: { "Content-Type":"application/json", Authorization:`Bearer ${token}`, ...(opts.headers||{}) }});
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.detail||res.statusText);
      return data;
    }
    function setSort(field){
      if(currentSortField===field) currentSortDir = currentSortDir==="asc"?"desc":"asc";
      else { currentSortField=field; currentSortDir="asc"; }
      updateSortIcons(); loadUsers();
    }
    function updateSortIcons(){
      ["id","role","grade_level","last_login"].forEach(f=>{ const el=document.getElementById(`sort-${f}`); if(el){el.textContent="‚Üï";el.className="text-slate-300";} });
      const active=document.getElementById(`sort-${currentSortField}`);
      if(active){active.textContent=currentSortDir==="asc"?"‚Üë":"‚Üì";active.className="text-indigo-600 font-bold";}
    }
    async function loadUsers(){
      try {
        const q=document.getElementById("q").value, role=document.getElementById("fRole").value, active=document.getElementById("fActive").value, grade=document.getElementById("fGrade").value;
        const params = new URLSearchParams({ q, page:pageNum, page_size:pageSize, sort:`${currentSortField}:${currentSortDir}` });
        if(role) params.append("role",role); if(active) params.append("active",active); if(grade) params.append("grade",grade);
        const data = await fetchJSON(`${API}/admin/users?${params}`);
        renderTable(data.items);
        document.getElementById("meta").textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${data.meta.page} / ${Math.ceil(data.meta.total/pageSize)} (‡∏£‡∏ß‡∏° ${data.meta.total})`;
        document.getElementById("prev").disabled = pageNum<=1; document.getElementById("next").disabled = pageNum*pageSize>=data.meta.total;
        loadMetrics();
      } catch(e) { alert(e.message); }
    }
    function renderTable(users){
      if(users.length===0){ tbody.innerHTML=`<tr><td colspan="7" class="px-6 py-10 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }
      tbody.innerHTML = users.map(u => {
        let statusHtml = "";
        if (!u.is_active) statusHtml = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-500 border border-slate-200">‚õî Inactive</span>`;
        else if (u.current_activity) statusHtml = `<div class="relative group inline-block"><span class="cursor-help inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-blue-50 text-blue-600 border border-blue-200"><span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span></span>Studying</span><div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-[200px] px-3 py-1.5 bg-slate-800 text-white text-xs rounded shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10 pointer-events-none text-center">${u.current_activity}<div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-800"></div></div></div>`;
        else if (u.is_online) statusHtml = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-emerald-50 text-emerald-600 border border-emerald-200"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> Online</span>`;
        else statusHtml = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold text-slate-400 border border-transparent"><span class="w-2 h-2 rounded-full bg-slate-300"></span> Offline</span>`;
        
        return `<tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0 group"><td class="px-6 py-4 text-slate-400 font-mono text-xs">#${u.id}</td><td class="px-6 py-4"><div class="flex items-center gap-3"><img src="${u.avatar_url ? (u.avatar_url.startsWith("http")?u.avatar_url:`${API}${u.avatar_url}`) : `https://ui-avatars.com/api/?name=${u.email}&background=random`}" class="w-8 h-8 rounded-full object-cover border border-slate-200"><div><div class="font-bold text-slate-700">${u.full_name||"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}</div><div class="text-xs text-slate-400">${u.email}</div></div></div></td><td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs font-bold border ${u.role==='admin'?'bg-purple-50 text-purple-700 border-purple-200':'bg-white text-slate-600 border-slate-200'}">${u.role.toUpperCase()}</span></td><td class="px-6 py-4">${statusHtml}</td><td class="px-6 py-4 text-slate-600 text-xs font-mono">${u.grade_level||"-"}</td><td class="px-6 py-4 text-slate-400 text-xs">${fmtDate(u.last_login)}</td><td class="px-6 py-4 text-right"><div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick='openEdit(${JSON.stringify(u).replace(/'/g, "&#39;")})' class="p-1.5 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded">‚úèÔ∏è</button><button onclick="deleteUser(${u.id})" class="p-1.5 text-slate-500 hover:text-red-600 hover:bg-red-50 rounded">üóëÔ∏è</button></div></td></tr>`;
      }).join("");
    }
    async function loadMetrics(){ try{const m=await fetchJSON(`${API}/admin/metrics`); document.getElementById("m_total").textContent=m.total_users; document.getElementById("m_new").textContent=m.new_users_today;}catch{} }
    async function deleteUser(id){ if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö ID:${id}?`))return; try{await fetchJSON(`${API}/admin/users/${id}`,{method:"DELETE"});loadUsers();}catch(e){alert(e.message);} }
    
    // Create/Edit
    const dlg=document.getElementById("editDlg"), form=document.getElementById("editForm"); let isCreateMode=false;
    document.getElementById("btnCreate").onclick=()=>{ isCreateMode=true; document.getElementById("dlgTitle").textContent="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà"; form.reset(); document.getElementById("edit_id").value=""; document.getElementById("edit_email").disabled=false; document.getElementById("edit_active").checked=true; document.getElementById("btnResetPass").style.display="none"; dlg.showModal(); };
    function openEdit(u){ isCreateMode=false; document.getElementById("dlgTitle").textContent=`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç #${u.id}`; document.getElementById("edit_id").value=u.id; document.getElementById("edit_email").value=u.email; document.getElementById("edit_email").disabled=true; document.getElementById("edit_full_name").value=u.full_name||""; document.getElementById("edit_role").value=u.role; document.getElementById("edit_grade").value=u.grade_level||""; document.getElementById("edit_active").checked=u.is_active; document.getElementById("btnResetPass").style.display="block"; dlg.showModal(); }
    form.onsubmit=async(e)=>{ e.preventDefault(); const pl={full_name:document.getElementById("edit_full_name").value, role:document.getElementById("edit_role").value, grade_level:document.getElementById("edit_grade").value||null, is_active:document.getElementById("edit_active").checked}; try{ if(isCreateMode){ pl.email=document.getElementById("edit_email").value; pl.password=prompt("‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:"); if(!pl.password)return; await fetchJSON(`${API}/admin/users`,{method:"POST",body:JSON.stringify(pl)}); }else{ await fetchJSON(`${API}/admin/users/${document.getElementById("edit_id").value}`,{method:"PATCH",body:JSON.stringify(pl)}); } dlg.close(); loadUsers(); }catch(e){alert(e.message);} };
    document.getElementById("btnResetPass").onclick=async()=>{ if(!confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™?"))return; try{ const res=await fetchJSON(`${API}/admin/users/${document.getElementById("edit_id").value}/reset-password`,{method:"POST"}); alert(`‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà: ${res.temp_password}`); }catch(e){alert(e.message);} };

    document.getElementById("btnSearch").onclick=()=>{pageNum=1;loadUsers();}; document.getElementById("fRole").onchange=()=>{pageNum=1;loadUsers();}; document.getElementById("fActive").onchange=()=>{pageNum=1;loadUsers();}; document.getElementById("fGrade").onchange=()=>{pageNum=1;loadUsers();}; document.getElementById("prev").onclick=()=>{if(pageNum>1){pageNum--;loadUsers();}}; document.getElementById("next").onclick=()=>{pageNum++;loadUsers();};
    
    updateSortIcons(); loadUsers();
  </script>
</body>
</html>