<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>โปรไฟล์ — EdTech</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50 p-6">
  <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow p-6 space-y-4">
    <h1 class="text-2xl font-bold">แก้ไขโปรไฟล์</h1>
    <div id="info" class="text-sm text-gray-600"></div>

    <form id="form" class="grid grid-cols-1 gap-4">
      <div class="flex items-center gap-4">
        <img id="avatar_preview" class="w-24 h-24 rounded-full object-cover border" alt="avatar" />
        <div>
          <label class="block text-sm mb-1">เลือกรูปโปรไฟล์ (JPG/PNG/WEBP ≤ 2MB)</label>
          <input id="avatar_file" type="file" accept="image/*" class="border rounded-lg p-2" />
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">ชื่อ - สกุล</label>
        <input id="full_name" type="text" class="w-full border rounded-lg p-3"/>
      </div>

      <div>
        <label class="block text-sm mb-1">Bio</label>
        <textarea id="bio" rows="3" class="w-full border rounded-lg p-3" placeholder="เล่าเกี่ยวกับตัวคุณสั้นๆ"></textarea>
      </div>

      <div>
        <label class="block text-sm mb-1">ระดับชั้น</label>
        <select id="grade_level" class="w-full border rounded-lg p-3">
          <option value="">-- เลือก --</option>
          <option value="M6">ม.6 (#dek69)</option>
          <option value="M5">ม.5 (#dek70)</option>
          <option value="M4">ม.4 (#dek71)</option>
          <option value="M3">ม.3 (#dek72)</option>
          <option value="M2">ม.2 (#dek73)</option>
          <option value="M1">ม.1 (#dek74)</option>
        </select>
        <p id="dek_hint" class="text-xs text-gray-500 mt-1"></p>
      </div>

      <div class="flex gap-3">
        <button class="flex-1 bg-black text-white rounded-xl p-3">บันทึก</button>
        <a href="./me.html" class="flex-1 text-center rounded-xl p-3 border">กลับหน้าโปรไฟล์</a>
      </div>
    </form>
    <pre id="msg" class="text-sm"></pre>
  </div>

<script>
const API = (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost")
  ? "https://edtech-api-zigm.onrender.com"                       // ถ้าเปิดในเครื่อง ใช้ Database ในเครื่อง
  : "https://edtech-api-zigm.onrender.com";       // ถ้าอยู่บนเว็บจริง ให้ใช้ Database ของจริงzigm.onrender.com";
const token = localStorage.getItem("token");
const msg = document.getElementById("msg");
const info = document.getElementById("info");
const dekHint = document.getElementById("dek_hint");
const fileInput = document.getElementById("avatar_file");
const preview = document.getElementById("avatar_preview");

if (!token) location.href = "./login.html";

function dekFromGrade(gl){
  const map = {M6:69,M5:70,M4:71,M3:72,M2:73,M1:74};
  return map[gl] || null;
}

async function loadMe(){
  try{
    const res = await fetch(`${API}/users/me`, { headers: { Authorization: `Bearer ${token}` }});
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail || "โหลดข้อมูลไม่สำเร็จ");
    info.textContent = `อีเมล: ${data.email} | บทบาท: ${data.role || 'student'}`;
    document.getElementById("full_name").value = data.full_name || "";
    document.getElementById("bio").value = data.bio || "";
    document.getElementById("grade_level").value = data.grade_level || "";
    const d = dekFromGrade(data.grade_level);
    dekHint.textContent = d ? `dek code ปัจจุบัน: #dek${d}` : "";
    preview.src = data.avatar_url
      ? API + data.avatar_url
      : "https://ui-avatars.com/api/?background=random&name=" + encodeURIComponent(data.full_name || data.email);

  }catch(e){
    msg.className = "text-red-600";
    msg.textContent = "❌ " + e.message;
  }
}

fileInput.addEventListener("change", () => {
  const f = fileInput.files?.[0];
  if (f) preview.src = URL.createObjectURL(f);
});

document.getElementById("grade_level").addEventListener("change", (e)=>{
  const gl = e.target.value;
  const d = dekFromGrade(gl);
  dekHint.textContent = d ? `dek code = #dek${d}` : "";
});

document.getElementById("form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  msg.className = "";
  msg.textContent = "กำลังบันทึก...";

  const form = new FormData();
  form.append("full_name", document.getElementById("full_name").value.trim());
  form.append("bio", document.getElementById("bio").value.trim());
  form.append("grade_level", document.getElementById("grade_level").value);
  if (fileInput.files[0]) form.append("file", fileInput.files[0]);

  try {
    const res = await fetch(`${API}/users/me`, {
      method: "POST",
      headers: { Authorization: `Bearer ${token}` },
      body: form
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "บันทึกไม่สำเร็จ");
    msg.className = "text-green-600";
    msg.textContent = "✅ บันทึกเรียบร้อย";
    if (data.avatar_url) preview.src = API + data.avatar_url;
    await loadMe();
  } catch (e) {
    msg.className = "text-red-600";
    msg.textContent = "❌ " + e.message;
  }
});

loadMe();
</script>
</body>
</html>
