<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ห้องเรียน — MingSmileyFace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #0f172a; user-select: none; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    
    /* Lesson Item */
    .lesson-item { transition: all 0.2s; border-left: 3px solid transparent; }
    .lesson-item:hover { background-color: rgba(255,255,255,0.03); }
    .lesson-item.active { background-color: rgba(79, 70, 229, 0.1); border-left-color: #6366f1; }
    .lesson-item.active .lesson-title { color: #818cf8; font-weight: 500; }
    
    /* Chapter Header */
    .chapter-header { position: sticky; top: 0; z-index: 10; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(4px); border-bottom: 1px solid #1e293b; }
    
    /* Checkbox */
    .chk-circle { appearance: none; width: 18px; height: 18px; border: 2px solid #475569; border-radius: 50%; display: grid; place-content: center; cursor: pointer; transition: all 0.2s; }
    .chk-circle:checked { background: #10b981; border-color: #10b981; }
    .chk-circle:checked::before { content: "✓"; color: white; font-size: 10px; font-weight: bold; }
    
    /* Video Player Styles */
    .video-wrapper { position: relative; width: 100%; padding-bottom: 56.25%; background: #000; border-radius: 1rem; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1); }
    .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .click-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; cursor: pointer; }
    .custom-controls { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 15px 20px; opacity: 0; transition: opacity 0.3s; z-index: 30; display: flex; flex-direction: column; gap: 8px; }
    .video-wrapper:hover .custom-controls, .video-wrapper.paused .custom-controls { opacity: 1; }
    
    /* Controls UI */
    .progress-range { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; cursor: pointer; }
    .progress-range::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: #6366f1; border-radius: 50%; cursor: pointer; transition: transform 0.1s; }
    .progress-range:hover::-webkit-slider-thumb { transform: scale(1.5); }
    .vol-slider { width: 0; overflow: hidden; transition: width 0.3s; -webkit-appearance: none; appearance: none; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
    .group-vol:hover .vol-slider { width: 60px; margin-left: 8px; }
    .vol-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 10px; height: 10px; background: white; border-radius: 50%; cursor: pointer; }
    .speed-menu { position: absolute; bottom: 100%; right: 0; background: rgba(15,23,42,0.95); backdrop-filter: blur(8px); border-radius: 8px; padding: 4px; display: none; flex-direction: column; gap: 2px; margin-bottom: 8px; min-width: 60px; border: 1px solid rgba(255,255,255,0.1); }
    .speed-menu.show { display: flex; }
    .speed-opt { color: #cbd5e1; font-size: 12px; padding: 6px 12px; cursor: pointer; border-radius: 4px; text-align: center; }
    .speed-opt:hover { background: rgba(255,255,255,0.1); color: white; }
    .speed-opt.active { color: #818cf8; font-weight: bold; background: rgba(99, 102, 241, 0.1); }
    .big-play-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 70px; height: 70px; background: rgba(99,102,241,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 25; pointer-events: none; opacity: 0; transition: all 0.3s; }
    .video-wrapper.paused .big-play-btn { opacity: 1; transform: translate(-50%,-50%) scale(1); }
    .video-wrapper.paused::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 5; pointer-events: none; }
    
    /* Netflix Next Button */
    #nextEpBtn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; transform: translateY(20px); pointer-events: none; }
    #nextEpBtn.show { transform: translateY(0); opacity: 1; pointer-events: auto; }

    /* Neon Effect */
    @keyframes neon-breath {
        0%, 100% { box-shadow: 0 0 5px rgba(6, 182, 212, 0.3), inset 0 0 5px rgba(6, 182, 212, 0.1); border-color: #06b6d4; color: #06b6d4; }
        50% { box-shadow: 0 0 15px rgba(34, 211, 238, 0.8), inset 0 0 10px rgba(34, 211, 238, 0.2); border-color: #22d3ee; color: #22d3ee; text-shadow: 0 0 8px rgba(34, 211, 238, 0.6); }
    }
    .neon-btn { color: #06b6d4; border: 1px solid #06b6d4; background: rgba(6, 182, 212, 0.05); box-shadow: 0 0 5px rgba(6, 182, 212, 0.2); transition: all 0.3s ease; }
    .neon-btn:hover { background: rgba(6, 182, 212, 0.15); transform: translateY(-2px); animation: neon-breath 2s infinite ease-in-out; }

    /* Star Rating */
    .star { cursor: pointer; color: #475569; transition: color 0.2s, transform 0.2s; }
    .star.active, .star:hover { color: #fbbf24; transform: scale(1.2); }
    /* SwAl fix */
    .swal2-container { z-index: 2147483647 !important; }
  </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-200" oncontextmenu="return false">

  <header class="bg-slate-900 border-b border-slate-800 h-16 shrink-0 flex items-center justify-between px-4 z-30 shadow-md">
    <div class="flex items-center gap-4">
      <a id="backBtn" href="#" class="p-2 hover:bg-slate-800 rounded-full transition text-slate-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg></a>
      <h1 class="font-bold text-lg text-white truncate max-w-xs" id="courseTitle">Loading...</h1>
    </div>
    <div class="flex items-center gap-3 bg-slate-800 px-4 py-1.5 rounded-full border border-slate-700">
      <span id="topProgressText" class="font-mono font-bold text-indigo-400 text-sm">0%</span>
      <div class="w-24 h-1.5 bg-slate-700 rounded-full overflow-hidden"><div id="topProgressBar" class="h-full bg-emerald-500 transition-all duration-500" style="width: 0%"></div></div>
    </div>
  </header>

  <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
    <aside class="w-full lg:w-96 bg-slate-900 border-r border-slate-800 flex flex-col h-[35vh] lg:h-auto shrink-0 z-20 order-2 lg:order-1">
      <div id="playlist" class="flex-1 overflow-y-auto"></div>
    </aside>

    <main class="flex-1 bg-black flex flex-col items-center p-4 lg:p-8 order-1 lg:order-2 overflow-y-auto bg-slate-950 pt-10 relative">
      <div class="w-full max-w-5xl space-y-6">
        
        <div id="videoWrapper" class="video-wrapper paused">
           <div id="player"></div>
           <div class="click-layer" onclick="togglePlay()"></div>
           <div class="big-play-btn"><svg class="w-10 h-10 text-white ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
           
           <button id="nextEpBtn" class="absolute bottom-20 right-5 bg-white text-slate-900 px-5 py-3 rounded-xl font-bold shadow-2xl z-40 flex items-center gap-4 group border border-indigo-100 hover:scale-105" onclick="nextLesson()">
               <div class="relative w-10 h-10 flex-shrink-0">
                   <svg class="w-full h-full -rotate-90 text-slate-200" viewBox="0 0 36 36"><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" /></svg>
                   <svg class="w-full h-full -rotate-90 text-indigo-600 absolute top-0 left-0" viewBox="0 0 36 36"><path id="nextCountdownCircle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" stroke-dasharray="0, 100" /></svg>
                   <div class="absolute inset-0 flex items-center justify-center"><svg class="w-4 h-4 text-slate-800 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
               </div>
               <div class="text-left min-w-[100px]">
                   <div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">เล่นถัดไป</div>
                   <div class="text-sm font-bold truncate max-w-[150px] leading-tight" id="nextEpTitle">...</div>
               </div>
           </button>

           <div class="custom-controls" onclick="event.stopPropagation()">
              <input type="range" class="progress-range" id="progressBar" value="0" min="0" max="100" step="0.1" 
                     oninput="seekVideo(this.value)" onmousedown="startDragging()" onmouseup="stopDragging()" ontouchstart="startDragging()" ontouchend="stopDragging()">
              
              <div class="flex justify-between items-center text-xs font-mono text-slate-300">
                 <div class="flex items-center gap-4">
                    <button class="hover:text-white" onclick="togglePlay()"><svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                    <div class="flex items-center group-vol">
                        <button class="hover:text-white" onclick="toggleMute()"><svg id="volIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg></button>
                        <input type="range" class="vol-slider" min="0" max="100" value="100" oninput="setVolume(this.value)">
                    </div>
                    <span><span id="currentTime">0:00</span> / <span id="duration">0:00</span></span>
                 </div>
                 <div class="flex items-center gap-4 relative">
                    <div class="relative">
                        <button class="hover:text-white font-bold" onclick="document.getElementById('speedMenu').classList.toggle('show')"><span id="speedLabel">1x</span></button>
                        <div class="speed-menu" id="speedMenu">
                            <div class="speed-opt" onclick="setSpeed(0.5)">0.5x</div><div class="speed-opt" onclick="setSpeed(0.75)">0.75x</div>
                            <div class="speed-opt active" onclick="setSpeed(1)">Normal</div>
                            <div class="speed-opt" onclick="setSpeed(1.25)">1.25x</div><div class="speed-opt" onclick="setSpeed(1.5)">1.5x</div><div class="speed-opt" onclick="setSpeed(2)">2.0x</div>
                        </div>
                    </div>
                    <button class="hover:text-white" onclick="toggleFullscreen()"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg></button>
                 </div>
              </div>
           </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-4">
           <div class="flex-1">
             <h1 class="text-2xl font-bold text-white mb-2" id="lessonTitle">...</h1>
             <div class="flex flex-wrap gap-3 text-xs text-slate-400 items-center">
               <span id="lessonMeta">...</span>
               <button onclick="openReport()" class="flex items-center gap-1 hover:text-red-400 transition text-red-500/80">
                  <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg> แจ้งปัญหา
               </button>
             </div>
           </div>
           
           <div class="flex flex-wrap gap-2 items-center">
             <a id="docBtn" href="#" target="_blank" class="hidden items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition group neon-btn" title="ดาวน์โหลดเอกสาร">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <span class="relative z-10">เอกสารประกอบ</span>
             </a>
             <button onclick="prevLesson()" id="btnPrev" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-bold transition disabled:opacity-50">&lt; Prev</button>
             <button onclick="nextLesson()" id="btnNext" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold transition disabled:opacity-50">Next &gt;</button>
           </div>
        </div>

        <div class="bg-slate-900 rounded-xl border border-slate-800 p-6 space-y-6" id="commentSection">
            <div class="flex items-center justify-between bg-slate-800/50 p-4 rounded-lg">
                <div>
                    <h3 class="font-bold text-sm text-slate-300">ให้คะแนนบทเรียนนี้</h3>
                    <p class="text-xs text-slate-500">คะแนนเฉลี่ย: <span id="avgRating" class="font-mono text-emerald-400 font-bold text-lg ml-1">-</span></p>
                </div>
                <div class="flex gap-2">
                    <button class="star text-2xl text-slate-600 transition" onclick="rate(1)">★</button>
                    <button class="star text-2xl text-slate-600 transition" onclick="rate(2)">★</button>
                    <button class="star text-2xl text-slate-600 transition" onclick="rate(3)">★</button>
                    <button class="star text-2xl text-slate-600 transition" onclick="rate(4)">★</button>
                    <button class="star text-2xl text-slate-600 transition" onclick="rate(5)">★</button>
                </div>
            </div>
            
            <div class="flex gap-3">
                <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center font-bold text-white shrink-0 shadow-lg text-sm">Me</div>
                <div class="flex-1">
                    <textarea id="commentText" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition placeholder-slate-500" rows="2" placeholder="เขียนความคิดเห็น..."></textarea>
                    <div class="flex justify-end mt-2">
                        <button onclick="postComment()" class="px-5 py-2 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-500 transition shadow-lg flex items-center gap-2">
                            <span>ส่งความคิดเห็น</span>
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="commentList" class="space-y-4 max-h-[500px] overflow-y-auto custom-scroll pr-2 pb-4"></div>
        </div>
      </div>
    </main>
  </div>

  <dialog id="reportDlg" class="p-0 rounded-xl bg-slate-900 text-slate-200 shadow-2xl backdrop:bg-black/80"><div class="p-6 w-80"><h3 class="font-bold text-lg mb-4 text-white">แจ้งปัญหาคลิป</h3><textarea id="reportReason" class="w-full bg-slate-800 border border-slate-700 rounded p-3 text-sm mb-4 text-white" rows="3" placeholder="เช่น เสียงเบา, คลิปเสีย..."></textarea><div class="flex justify-end gap-2"><button onclick="document.getElementById('reportDlg').close()" class="px-3 py-1.5 text-xs text-slate-400 hover:text-white">ยกเลิก</button><button onclick="sendReport()" class="px-3 py-1.5 bg-red-600 text-white rounded text-xs font-bold hover:bg-red-700">ส่งรายงาน</button></div></div></dialog>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    document.onkeydown = (e) => { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0))) return false; }

    const API = (window.location.hostname==="127.0.0.1"||window.location.hostname==="localhost")?"https://edtech-api-zigm.onrender.com":"https://edtech-api-zigm.onrender.com";
    const token = localStorage.getItem("token");
    if(!token) location.href="./login.html";

    const params = new URLSearchParams(window.location.search);
    const courseId = params.get("id");
    if(!courseId) location.href="./me.html";
    document.getElementById("backBtn").href = `./course_content.html?id=${courseId}`;

    let courseData=null, completedSet=new Set(), allLessons=[], player=null, currentIdx=0;
    let saveInterval, heartbeatInterval;
    let isDragging = false, resumeTime = 0, videoEnded = false;

    // --- Video Logic ---
    function startDragging() { isDragging = true; }
    function stopDragging() { isDragging = false; if(player && player.seekTo) { const val = document.getElementById("progressBar").value; player.seekTo((val/100) * player.getDuration(), true); } }

    async function init(){
        try {
            const [cRes, pRes] = await Promise.all([
                fetch(`${API}/courses/${courseId}`, {headers:{Authorization:`Bearer ${token}`}}),
                fetch(`${API}/courses/${courseId}/my-progress`, {headers:{Authorization:`Bearer ${token}`}})
            ]);

            if (!cRes.ok) {
                Swal.fire("ไม่พบข้อมูล", "ไม่พบคอร์สเรียน หรือคุณยังไม่ได้ลงทะเบียน", "error").then(() => location.href = "./course.html");
                return;
            }
            
            // ✅ FIX: สลับบรรทัดให้ถูกต้อง (เอาค่าใส่ตัวแปรก่อนค่อยเช็ค)
            courseData = await cRes.json();
            if (!courseData) throw new Error("Course Data is null");

            const prog = pRes.ok ? await pRes.json() : { completed_ids: [] };
            completedSet = new Set(prog.completed_ids || []);
            
            document.getElementById("courseTitle").textContent = courseData.title || "Untitled";
            const listEl = document.getElementById("playlist");
            listEl.innerHTML = "";
            
            if(courseData.chapters) {
                courseData.chapters.sort((a,b)=>a.order-b.order).forEach(ch => {
                    const chHeader = document.createElement("div");
                    chHeader.className = "chapter-header px-4 py-3 text-[10px] font-bold text-indigo-300 uppercase tracking-widest border-b border-slate-800/50 bg-slate-900/95 sticky top-0 z-10";
                    chHeader.textContent = ch.title;
                    listEl.appendChild(chHeader);

                    if(ch.lessons) {
                        ch.lessons.sort((a,b)=>a.order-b.order).forEach((l, localIndex) => {
                            l.chapterTitle = ch.title;
                            l.globalIndex = allLessons.length;
                            allLessons.push(l);
                            const div = document.createElement("div");
                            div.className = `lesson-item flex items-center gap-3 p-3.5 cursor-pointer border-b border-slate-800/50`;
                            div.dataset.idx = l.globalIndex; 
                            div.innerHTML = `<div class="shrink-0" onclick="event.stopPropagation()"><input type="checkbox" class="chk-circle" onchange="toggleLesson(${l.id}, this)"></div><div class="flex-1 min-w-0" onclick="loadLesson(${l.globalIndex})"><div class="flex items-center gap-2 mb-0.5"><span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">EP.${localIndex+1}</span>${l.duration ? `<span class="text-[9px] bg-slate-800 text-slate-400 px-1.5 rounded font-mono">${l.duration}m</span>` : ''}</div><div class="text-sm font-medium truncate text-slate-300 lesson-title">${l.title}</div></div>`;
                            listEl.appendChild(div);
                        });
                    }
                });
            }
            
            updateProgressUI();
            const startL = params.get("lesson");
            let idx = startL ? allLessons.findIndex(l=>l.id==startL) : allLessons.findIndex(l=>!completedSet.has(l.id));
            if(idx<0) idx=0;
            
            if(window.YT && window.YT.Player) loadLesson(idx);
            else window.onYouTubeIframeAPIReady = () => loadLesson(idx);

        } catch (e) {
            console.error(e);
            Swal.fire("Error", "เกิดข้อผิดพลาดในการโหลดข้อมูล", "error").then(() => location.href = "./course.html");
        }
    }

    function extractYoutubeId(url) { if(!url) return null; const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/; const match = url.match(regExp); return (match && match[2].length == 11) ? match[2] : url; }

    async function loadLesson(idx){
        if(!allLessons[idx]) return;
        currentIdx = idx;
        const l = allLessons[idx];
        const vid = extractYoutubeId(l.youtube_id);
        
        document.getElementById("lessonTitle").textContent = l.title;
        document.getElementById("lessonMeta").textContent = l.chapterTitle;

        const docBtn = document.getElementById("docBtn");
        if(l.doc_url) { docBtn.href = l.doc_url; docBtn.classList.remove("hidden"); docBtn.classList.add("flex"); } else { docBtn.classList.add("hidden"); docBtn.classList.remove("flex"); }

        resumeTime = 0;
        try { const r = await fetch(`${API}/courses/${courseId}/lessons/${l.id}/progress`, {headers:{Authorization:`Bearer ${token}`}}); const d = await r.json(); resumeTime = parseInt(d.seconds) || 0; } catch {}

        if(player && player.loadVideoById){ player.loadVideoById({videoId:vid, startSeconds:resumeTime}); } 
        else { player = new YT.Player('player', { height:'100%', width:'100%', videoId:vid, playerVars: { autoplay:1, controls:0, rel:0, start:resumeTime }, events: { onReady: e=>e.target.playVideo(), onStateChange: onStateChange } }); setInterval(updateLoop, 500); }

        document.querySelectorAll(".lesson-item").forEach(e => e.classList.remove("active"));
        const active = document.querySelector(`.lesson-item[data-idx="${idx}"]`);
        if(active) { active.classList.add("active"); active.scrollIntoView({behavior:"smooth", block:"center"}); }
        
        // Reload Interactions
        await loadComments(l.id); 
        await loadRating(l.id);
        
        const nextL = allLessons[currentIdx+1];
        if(nextL) document.getElementById("nextEpTitle").textContent = nextL.title;
        document.getElementById("btnPrev").disabled = (idx === 0);
        document.getElementById("btnNext").disabled = (idx === allLessons.length - 1);
    }

    function onStateChange(e){
        const w = document.getElementById("videoWrapper");
        if(e.data == YT.PlayerState.PLAYING){ w.classList.remove("paused"); document.getElementById("playIcon").innerHTML = `<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>`; startSaveLoop(); startHeartbeat(); const cur = player.getCurrentTime(); if(resumeTime > 0 && Math.abs(cur - resumeTime) > 2) { player.seekTo(resumeTime, true); resumeTime = 0; } } 
        else { w.classList.add("paused"); document.getElementById("playIcon").innerHTML = `<path d="M8 5v14l11-7z"/>`; stopSaveLoop(); stopHeartbeat(); }
    }

    function updateLoop(){
        if(!player || !player.getDuration) return;
        const cur = player.getCurrentTime();
        const dur = player.getDuration();
        document.getElementById("currentTime").textContent = fmtTime(cur);
        document.getElementById("duration").textContent = fmtTime(dur);
        if(!isDragging){ const pct = (cur/dur)*100; const bar = document.getElementById("progressBar"); bar.value = pct; bar.style.background = `linear-gradient(to right, #6366f1 ${pct}%, rgba(255,255,255,0.3) ${pct}%)`; }
        const timeLeft = dur - cur;
        if (timeLeft > 15) { hideNextButton(); }
        if(dur > 0 && timeLeft <= 15 && !videoEnded && !isDragging) {
             const lid = allLessons[currentIdx].id;
             if(!completedSet.has(lid)) toggleLesson(lid, null, true);
             if(allLessons[currentIdx+1]) {
                 const btn = document.getElementById("nextEpBtn");
                 if (!btn.classList.contains("show")) btn.classList.add("show");
                 const circle = document.getElementById("nextCountdownCircle");
                 const dash = ((15 - timeLeft) / 15) * 100; circle.style.strokeDasharray = `${dash}, 100`;
             }
        }
    }
    
    function hideNextButton() { document.getElementById("nextEpBtn").classList.remove("show"); }
    function startSaveLoop(){ if(saveInterval) clearInterval(saveInterval); saveInterval = setInterval(()=>{ const cur = Math.floor(player.getCurrentTime()); fetch(`${API}/courses/${courseId}/lessons/${allLessons[currentIdx].id}/progress`, { method:"POST", headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` }, body: JSON.stringify({seconds: cur}) }); }, 5000); }
    function stopSaveLoop(){ clearInterval(saveInterval); }
    function startHeartbeat(){ if(heartbeatInterval) clearInterval(heartbeatInterval); heartbeatInterval = setInterval(()=>{ fetch(`${API}/users/me/study-time`, { method:"POST", headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` }, body: JSON.stringify({minutes: 1}) }); }, 60000); }
    function stopHeartbeat(){ clearInterval(heartbeatInterval); }
    function fmtTime(s){ const m=Math.floor(s/60), sec=Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; }
    function togglePlay(){ if(player.getPlayerState()==1) player.pauseVideo(); else player.playVideo(); }
    function seekVideo(pct){ /* handled in drag */ }
    function setVolume(v){ player.setVolume(v); }
    function toggleMute(){ if(player.isMuted()){player.unMute();document.getElementById("volIcon").style.opacity=1;}else{player.mute();document.getElementById("volIcon").style.opacity=0.5;} }
    function setSpeed(s){ player.setPlaybackRate(s); document.getElementById("speedLabel").textContent=s+"x"; document.getElementById("speedMenu").classList.remove("show"); }
    function toggleFullscreen(){ const el=document.getElementById("videoWrapper"); if(!document.fullscreenElement) el.requestFullscreen(); else document.exitFullscreen(); }
    function prevLesson(){ loadLesson(currentIdx-1); }
    function nextLesson(){ loadLesson(currentIdx+1); }

    async function toggleLesson(lid, chk, force=false) {
        if(!chk && !force) return;
        const shouldAdd = force ? true : chk.checked;
        if(shouldAdd) completedSet.add(lid); else completedSet.delete(lid);
        updateProgressUI();
        try { await fetch(`${API}/courses/${courseId}/lessons/${lid}/toggle-progress`, { method: "POST", headers: { Authorization: `Bearer ${token}` } }); } catch { if(shouldAdd) completedSet.delete(lid); else completedSet.add(lid); updateProgressUI(); }
    }

    function updateProgressUI(){
        allLessons.forEach((l, i) => { const item = document.querySelector(`.lesson-item[data-idx="${i}"]`); if(item) { item.querySelector("input").checked = completedSet.has(l.id); } });
        const pct = Math.round((completedSet.size / allLessons.length) * 100) || 0;
        document.getElementById("topProgressBar").style.width = `${pct}%`;
        document.getElementById("topProgressText").textContent = `${pct}%`;
    }

    // --- COMMENTS & RATINGS LOGIC ---
    async function loadComments(lid) {
        const el = document.getElementById("commentList"); 
        try {
            const res = await fetch(`${API}/lessons/${lid}/comments`, {headers:{Authorization:`Bearer ${token}`}});
            const list = await res.json();
            if(list.length > 0) {
                el.innerHTML = list.map(c => `
                    <div class="flex gap-3 text-sm p-3 bg-slate-800/30 rounded-xl border border-slate-800">
                        <div class="w-8 h-8 rounded-full bg-indigo-900/50 flex items-center justify-center font-bold text-indigo-400 text-xs shrink-0 border border-indigo-800">
                            ${(c.user?.full_name||'User')[0].toUpperCase()}
                        </div>
                        <div>
                            <div class="font-bold text-indigo-300 text-xs mb-0.5">${c.user?.full_name||'Unknown User'}</div>
                            <div class="text-slate-300 leading-relaxed">${c.text}</div>
                        </div>
                    </div>`).join("");
            } else {
                el.innerHTML = `<div class="text-center text-slate-500 py-6 text-sm italic">ยังไม่มีคอมเมนต์ เป็นคนแรกที่เริ่มเลย!</div>`;
            }
        } catch { el.innerHTML = `<div class="text-center text-red-400 py-4 text-xs">โหลดคอมเมนต์ไม่สำเร็จ</div>`; }
    }

    async function postComment() {
        const txt = document.getElementById("commentText").value.trim();
        if(!txt) return;
        const btn = document.querySelector("#commentSection button");
        btn.disabled = true; btn.style.opacity = "0.5";
        try {
            const res = await fetch(`${API}/lessons/${allLessons[currentIdx].id}/comments`, {
                method: "POST", headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ text: txt })
            });
            if(res.ok) { document.getElementById("commentText").value = ""; await loadComments(allLessons[currentIdx].id); }
        } catch(e) { console.error(e); } 
        finally { btn.disabled = false; btn.style.opacity = "1"; }
    }

    async function loadRating(lid){ 
        try {
            const res = await fetch(`${API}/lessons/${lid}/rating`, {headers:{Authorization:`Bearer ${token}`}});
            const d = await res.json(); 
            document.getElementById("avgRating").textContent = (d.avg || 0).toFixed(1); 
            updateStars(d.my || 0); 
        } catch{} 
    }

    async function rate(s){ 
        updateStars(s);
        try {
            await fetch(`${API}/lessons/${allLessons[currentIdx].id}/rate`, {
                method:"POST", headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},
                body:JSON.stringify({score:s})
            });
            await loadRating(allLessons[currentIdx].id); 
        } catch {} 
    }

    function updateStars(s){ 
        document.querySelectorAll(".star").forEach((e,i) => {
            if (i < s) { e.classList.remove("text-slate-600"); e.classList.add("text-yellow-400", "scale-110"); } 
            else { e.classList.remove("text-yellow-400", "scale-110"); e.classList.add("text-slate-600"); }
        }); 
    }
    
    function openReport() { document.getElementById("reportDlg").showModal(); }
    async function sendReport() { 
        const r = document.getElementById("reportReason").value; if(!r) return; 
        try { await fetch(`${API}/reports`, { method:"POST", headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` }, body:JSON.stringify({target_type:"lesson", target_id:allLessons[currentIdx].id, reason:r}) }); alert("แจ้งปัญหาแล้ว"); document.getElementById("reportDlg").close(); } catch { alert("Error"); } 
    }

    init();
  </script>
</body>
</html>