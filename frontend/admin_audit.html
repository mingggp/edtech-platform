<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Audit Logs ‚Äî Admin</title><script src="https://cdn.tailwindcss.com"></script>
  <style>.admin-gradient{background:linear-gradient(135deg,#111827 0%,#1e1b4b 100%)}dialog::backdrop{background:rgba(0,0,0,0.5);backdrop-filter:blur(2px)}</style>
</head>
<body class="min-h-screen bg-slate-100 font-sans text-slate-800">
  <header class="admin-gradient text-white shadow-md sticky top-0 z-50">
    <nav class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between relative">
      <a href="./admin_users.html" class="flex items-center gap-3 group relative z-10"><img src="http://127.0.0.1:8000/static/logo.png" alt="Logo" class="h-12 w-auto object-contain bg-white/10 rounded p-1"><div class="leading-tight"><div class="font-bold text-lg">ADMIN CONSOLE</div></div></a>
      <div class="relative bg-white/10 p-1.5 rounded-xl hidden md:flex items-center gap-1">
        <div id="nav-slider" class="absolute h-[calc(100%-12px)] top-1.5 bg-white/20 rounded-lg transition-all duration-300 ease-out opacity-0 pointer-events-none z-0"></div>
        <a href="./admin_users.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="users">üë• Users</a>
        <a href="./admin_courses.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="courses">üìö Courses</a>
        <a href="./admin_payments.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="payments">üí∞ Payments</a>
        <a href="./admin_exams.html" class="nav-link px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white relative z-10 transition-colors" data-page="exams">üìù Exams</a>
        <a href="./admin_audit.html" class="nav-link px-4 py-2 rounded-lg text-sm font-bold text-slate-300 hover:text-white relative z-10 transition-colors" data-page="audit">üõ°Ô∏è Logs</a>
      </div>
      <div class="flex items-center gap-4 relative z-10"><a href="./me.html" class="text-xs text-slate-300 hover:text-white border-b border-transparent hover:border-slate-300 transition">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a><button onclick="logout()" class="text-xs bg-red-500/20 hover:bg-red-500 text-red-100 px-3 py-1.5 rounded transition">Logout</button></div>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-6">
    <div class="flex items-center justify-between"><h1 class="text-3xl font-bold text-slate-900">Audit Logs</h1><p class="text-sm text-slate-500">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p></div>
    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-wrap gap-2 items-end">
      <div><label class="text-xs text-slate-500 font-bold">Action</label><input id="fAction" class="border rounded px-3 py-2 text-sm w-40" placeholder="LOGIN..."></div>
      <div><label class="text-xs text-slate-500 font-bold">User ID</label><input id="fActor" class="border rounded px-3 py-2 text-sm w-20" type="number"></div>
      <div><label class="text-xs text-slate-500 font-bold">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="fFrom" class="border rounded px-3 py-2 text-sm" type="date"></div>
      <div><label class="text-xs text-slate-500 font-bold">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="fTo" class="border rounded px-3 py-2 text-sm" type="date"></div>
      <button id="btnSearch" class="px-4 py-2 bg-slate-800 text-white rounded text-sm hover:bg-slate-900">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-4">‡πÄ‡∏ß‡∏•‡∏≤</th><th class="p-4">Action</th><th class="p-4">User</th><th class="p-4">Detail</th><th class="p-4">Diff</th></tr></thead><tbody id="rows" class="divide-y"><tr><td colspan="5" class="p-8 text-center text-slate-400">Loading...</td></tr></tbody></table></div>
    <div class="flex justify-between items-center"><div id="meta" class="text-xs text-slate-500">Page 1</div><div class="flex gap-2"><button id="prev" class="px-3 py-1 border rounded text-xs">Prev</button><button id="next" class="px-3 py-1 border rounded text-xs">Next</button></div></div>
  </main>

  <dialog id="detailDlg" class="p-0 rounded-xl overflow-hidden backdrop:bg-black/50 shadow-2xl w-[600px]"><div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center"><h3 class="font-bold">Log Details</h3><button onclick="document.getElementById('detailDlg').close()" class="text-slate-400 hover:text-white">‚úï</button></div><div class="p-6 bg-white space-y-4 max-h-[80vh] overflow-y-auto"><h4 class="font-bold text-sm text-slate-700">Changes (Diff)</h4><table class="w-full text-xs border"><thead class="bg-slate-50"><tr class="text-left"><th class="p-2 border">Field</th><th class="p-2 border">Old</th><th class="p-2 border">New</th></tr></thead><tbody id="dlgDiff"></tbody></table><h4 class="font-bold text-sm text-slate-700 mt-4">Raw Data</h4><pre id="dlgRaw" class="bg-slate-50 p-3 rounded border text-xs overflow-auto"></pre></div></dialog>

  <script>
    const page="audit"; const slider=document.getElementById("nav-slider"); const links=document.querySelectorAll(".nav-link"); let activeLink=null;
    links.forEach(link=>{ if(link.dataset.page===page){activeLink=link;link.classList.add("text-white");moveSlider(link);slider.style.opacity="1";} link.addEventListener("mouseenter",(e)=>{moveSlider(e.target);slider.style.opacity="1";});});
    document.querySelector(".relative.bg-white\\/10").addEventListener("mouseleave",()=>{if(activeLink)moveSlider(activeLink);else slider.style.opacity="0";});
    function moveSlider(el){slider.style.width=el.offsetWidth+"px";slider.style.left=el.offsetLeft+"px";}

    const API = (window.location.hostname==="127.0.0.1"||window.location.hostname==="localhost")?"http://127.0.0.1:8000":"https://edtech-api-zigm.onrender.com";
    const token = localStorage.getItem("token");
    if(!token) location.href="./login.html";
    function logout(){ localStorage.removeItem("token"); location.href="./login.html"; }

    let pageNum=1;
    async function loadLogs(){
      try{
        const q=new URLSearchParams({page:pageNum,page_size:20,sort:"created_at:desc"});
        if(document.getElementById("fAction").value) q.append("action",document.getElementById("fAction").value);
        if(document.getElementById("fActor").value) q.append("actor_id",document.getElementById("fActor").value);
        if(document.getElementById("fFrom").value) q.append("date_from",document.getElementById("fFrom").value);
        if(document.getElementById("fTo").value) q.append("date_to",document.getElementById("fTo").value);
        const res=await fetch(`${API}/admin/audit?${q}`,{headers:{Authorization:`Bearer ${token}`}});
        const data=await res.json();
        renderTable(data.items);
        document.getElementById("meta").textContent=`Page ${data.meta.page} / ${Math.ceil(data.meta.total/20)}`;
      }catch(e){}
    }
    function renderTable(list){
      document.getElementById("rows").innerHTML = list.map(l => `<tr class="hover:bg-slate-50"><td class="p-4 text-xs text-slate-500 whitespace-nowrap">${l.created_at_bkk}</td><td class="p-4 font-bold text-slate-700">${l.action}</td><td class="p-4 text-xs">ID: ${l.actor_id||"-"}</td><td class="p-4 text-xs text-slate-500 truncate max-w-[200px]">${l.data||""}</td><td class="p-4"><button onclick='openDetail(${JSON.stringify(l).replace(/'/g,"&#39;")})' class="text-xs bg-slate-200 px-2 py-1 rounded hover:bg-slate-300">View</button></td></tr>`).join("");
    }
    function openDetail(l){
      const diffEl=document.getElementById("dlgDiff"); diffEl.innerHTML="";
      if(l.diff && l.diff.length){ l.diff.forEach(d=>{ diffEl.innerHTML+=`<tr class="${d.status==='changed'?'bg-yellow-50':(d.status==='added'?'bg-green-50':'bg-red-50')}"><td class="p-2 border font-mono text-slate-600">${d.field}</td><td class="p-2 border text-red-600">${d.before||"-"}</td><td class="p-2 border text-green-600">${d.after||"-"}</td></tr>`; }); } else { diffEl.innerHTML=`<tr><td colspan="3" class="p-4 text-center text-slate-400">No changes detected</td></tr>`; }
      document.getElementById("dlgRaw").textContent=l.data?JSON.stringify(JSON.parse(l.data),null,2):"-";
      document.getElementById("detailDlg").showModal();
    }
    document.getElementById("btnSearch").onclick=()=>{pageNum=1;loadLogs();}; document.getElementById("prev").onclick=()=>{if(pageNum>1){pageNum--;loadLogs();}}; document.getElementById("next").onclick=()=>{pageNum++;loadLogs();};
    loadLogs();
  </script>
</body>
</html>